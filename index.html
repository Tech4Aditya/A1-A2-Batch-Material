<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>JIIT A2 Study Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #e2e8f0;
            overflow-x: hidden;
        }
        .futuristic-card {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(25, 179, 219, 0.1);
            opacity: 0;
            transform: translateY(30px);
        }
        .futuristic-card:hover {
            box-shadow: 0 0 30px rgba(25, 179, 219, 0.4);
            transform: translateY(-5px);
        }
        .futuristic-card.animate-in {
            opacity: 1;
            transform: translateY(0);
        }
        .header-glow {
            box-shadow: 0 0 40px rgba(74, 144, 226, 0.3);
        }
        .subject-title {
            text-shadow: 0 0 10px currentColor;
        }
        .semester-btn, .chapter-btn, .day-btn, .portal-btn {
            background-color: #1f2937;
            color: #d1d5db;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            border: 1px solid #4b5563;
            transition: all 0.3s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .semester-btn:hover, .chapter-btn:hover, .day-btn:hover, .portal-btn:hover {
            background-color: #2d3748;
            color: #ffffff;
            border-color: #06b6d4;
        }
        .day-btn.active {
            background-color: #06b6d4;
            color: #ffffff;
            border-color: #06b6d4;
            box-shadow: 0 0 10px #06b6d4;
        }
        .semester-dropdown {
            background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #2d3748;
            box-shadow: 8px 30px rgba(0, 0, 0, 0.6);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .semester-dropdown.active {
            max-height: 500px;
        }
        .fade-out {
            transition: all 0.6s ease-out;
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
        }
        /* Aesthetic Clock and Button Styling */
        .glow-container {
            background-color: #1a202c;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.5);
            border: 1px solid rgba(6, 182, 212, 0.5);
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(6, 182, 212, 0.5); }
            50% { box-shadow: 0 0 25px rgba(6, 182, 212, 0.8); }
        }
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            position: relative;
            background-color: #1a202c;
            margin: 1.5rem;
            padding: 1.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 1200px;
            height: 90%;
            box-shadow: 0 0 40px rgba(6, 182, 212, 0.5);
            animation: modal-fade-in 0.3s ease-out;
        }
        @keyframes modal-fade-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .login-modal-content, .password-modal-content, .announcement-modal-content, .ai-modal-content {
            width: 90%;
            max-width: 500px;
            height: auto;
            padding: 2rem;
            background-color: #1a202c;
            box-shadow: 0 0 40px rgba(6, 182, 212, 0.5);
        }
        .full-screen-modal-content {
            width: 100%;
            max-width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            border-radius: 0;
            background-color: #0d1117;
            box-shadow: none;
        }
        .full-screen-modal-content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #d1d5db;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10;
        }
        .close-btn:hover {
            color: #ef4444;
        }
        
        .single-event-card {
            cursor: pointer;
            transition: transform 0.3s ease-in-out;
        }
        .single-event-card:hover {
            transform: scale(1.02);
        }

        /* New Futuristic Animation */
        .animated-event {
            animation: futuristicReveal 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes futuristicReveal {
            0% { opacity: 0; transform: translateY(20px) scale(0.9); box-shadow: 0 0 0px rgba(6, 182, 212, 0); }
            100% { opacity: 1; transform: translateY(0) scale(1); box-shadow: 0 0 15px rgba(6, 182, 212, 0.5); }
        }

        /* Chapter Buttons */
        .material-buttons-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        #portal-content {
            display: none;
        }

        .message-box {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 101;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: all 0.3s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        .message-box.show {
            transform: translateY(0);
            opacity: 1;
        }
        .current-class-glow {
            animation: pulse-glow 1.5s infinite;
        }
        .upcoming-class-glow {
            animation: pulse-glow-upcoming 1.5s infinite;
        }
        @keyframes pulse-glow-upcoming {
            0%, 100% { box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); }
            50% { box-shadow: 0 0 25px rgba(251, 191, 36, 0.8); }
        }
        
        /* Hide scrollbar for a cleaner look */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .loader-container {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(13, 17, 23, 0.95);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: #6ee7b7;
            font-size: 1.25rem;
        }
        .loader {
            border: 4px solid rgba(6, 182, 212, 0.3);
            border-radius: 50%;
            border-top: 4px solid #6ee7b7;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .portal-links-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            justify-content: center;
            align-items: center;
        }
        @media (min-width: 768px) {
            .portal-links-container {
                flex-direction: row;
            }
        }
        
        /* Bell button / popup behavior updated: popup placed under bell (top-right) */
        /* Bell icon will shake forever via the rule below */
        @keyframes shake {
            0% { transform: rotate(0deg); }
            20% { transform: rotate(-15deg); }
            40% { transform: rotate(15deg); }
            60% { transform: rotate(-10deg); }
            80% { transform: rotate(10deg); }
            100% { transform: rotate(0deg); }
        }
        #bell-button i {
            animation: shake 1.2s infinite ease-in-out;
            transform-origin: top center;
        }

        /* popup aligned under bell (instead of centered) */
        .pop-up {
            position: absolute;
            top: 70px;    /* below the bell */
            right: 20px;
            transform: none;
            z-index: 110;
            display: none;
        }
        #announcement-pop-up {
            display: none; /* Hide by default */
        }
        .pop-up-content {
            width: 90%;
            max-width: 500px;
            height: auto;
            padding: 2rem;
            background-color: #1a202c;
            box-shadow: 0 0 40px rgba(6, 182, 212, 0.5);
            border-radius: 1rem;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
        /* AI Assistant specific styling */
        .ai-response-container {
            min-height: 150px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Discussion Room specific styling */
        #chat-messages {
            height: calc(100% - 150px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 80%;
            display: flex;
            flex-direction: column;
        }
        .chat-message .sender-name {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .chat-message-other {
            background-color: #374151;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        .chat-message-own {
            background-color: #1d4ed8;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- The bell icon button -->
    <button id="bell-button" class="fixed top-6 right-6 p-4 bg-gray-900 text-gray-200 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-cyan-300 z-50">
        <i class="fas fa-bell text-2xl"></i>
    </button>
    
    <!-- The new announcement pop-up window -->
    <div id="announcement-pop-up" class="pop-up">
        <div id="announcement-content" class="pop-up-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-cyan-300">Important Announcements</h2>
                <button id="close-button" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="announcements-container" class="space-y-4">
                <!-- Announcements from Firebase will be loaded here -->
            </div>
            
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal active">
        <div class="modal-content login-modal-content flex flex-col items-center justify-center">
            <h2 class="text-2xl font-bold mb-4 text-cyan-300 text-center">Portal Login</h2>
            <p class="text-sm text-gray-400 mb-6 text-center">Enter your name and password to log in.</p>
            <form id="login-form" class="space-y-4 w-full">
                <div>
                    <input type="text" id="username" placeholder="Enter Full Name" class="w-full px-4 py-2 my-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-400" required>
                </div>
                <div>
                    <input type="password" id="password" placeholder="Enter Password" class="w-full px-4 py-2 my-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-400" required>
                </div>
                <button type="submit" class="portal-btn text-base p-2 w-full glow-container mt-4">
                    Log In
                </button>
            </form>
            <div id="login-message-box" class="message-box hidden mt-4 text-center"></div>
        </div>
    </div>

    <!-- Password Change Modal (Kept for UI but not functional) -->
    <div id="password-modal" class="modal">
        <div class="modal-content password-modal-content flex flex-col items-center justify-center">
            <span class="close-btn" id="close-password-modal">&times;</span>
            <h2 class="text-2xl font-bold mb-4 text-cyan-300 text-center">Change Password</h2>
            <p class="text-sm text-gray-400 mb-6 text-center">You are using a default password. It is recommended to change it for better security.</p>
            <form id="password-change-form" class="space-y-4 w-full">
                <div>
                    <input type="password" id="new-password" placeholder="Enter New Password" class="w-full px-4 py-2 my-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-400" required>
                </div>
                <div>
                    <input type="password" id="confirm-password" placeholder="Confirm Password" class="w-full px-4 py-2 my-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-400" required>
                </div>
                <button type="submit" class="portal-btn text-base p-2 w-full glow-container mt-4">
                    Change Password
                </button>
            </form>
            <div id="password-message-box" class="message-box hidden mt-4 text-center"></div>
        </div>
    </div>

    <!-- AI Help Modal -->
    <div id="ai-help-modal" class="modal">
        <div class="modal-content ai-modal-content flex flex-col">
            <button class="close-btn" id="close-ai-modal">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-cyan-300 text-center">AI Sahayak</h2>
            <p class="text-sm text-gray-400 mb-6 text-center">
                Apna sawaal ya anurodh likhein. Udaharan: "Mujhe Web Programming par ek project report ka draft chahiye."
            </p>
            <textarea id="ai-input" class="w-full h-32 p-4 mb-4 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-400 resize-none" placeholder="Apna prashna yahan likhein..."></textarea>
            <div class="flex space-x-4 mb-4">
                <button id="ai-generate-btn" class="portal-btn text-base p-2 w-full glow-container flex items-center justify-center">
                    <span class="mr-2">‚ú®</span>Jawaab Paayein
                </button>
                <button id="ai-clear-btn" class="portal-btn text-base p-2 w-full flex items-center justify-center">
                    Saaf Karein
                </button>
            </div>
            <div id="ai-response-container" class="bg-gray-900 rounded-lg p-4 border border-gray-700 text-sm text-gray-300 ai-response-container">
                Jawaab yahan dikhayega...
            </div>
            <div class="loader-container" id="ai-loader">
                <div class="loader"></div>
                <div class="mt-4">Jawaab banaya jaa raha hai...</div>
            </div>
        </div>
    </div>


    <div id="portal-content" class="flex flex-col min-h-screen">
        <!-- Header with Clock and Timetable button -->
        <header class="bg-gray-900 header-glow rounded-b-3xl mx-4 mt-4 p-4 md:mx-10 md:mt-10 md:p-6 lg:mx-20 lg:mt-12 lg:p-8 transition-all duration-300 flex flex-col md:flex-row justify-between items-center flex-wrap gap-4">
            <h1 class="text-2xl md:text-5xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 text-center md:text-left flex-grow">
                JIIT A2 Study Portal
            </h1>
            <div class="flex flex-col md:flex-row items-center gap-4">
                 <button id="logout-btn" class="semester-btn text-base p-2 bg-red-800/50 border-red-500/50 hover:bg-red-700/50">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
                <button id="show-timetable-btn" class="semester-btn text-base p-2">
                    View Timetable
                </button>
                <div id="clock" class="text-xl md:text-2xl font-bold text-gray-300 mt-2 md:mt-0 glow-container"></div>
            </div>
        </header>
        
        <!-- Welcome and User Info Section -->
        <section id="user-info-section" class="text-center py-8">
            <h2 id="welcome-message" class="text-2xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-lime-500">Welcome, Student!</h2>
        </section>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-20 transition-all duration-500 ease-out">
            
            <!-- Current Class/Break Section -->
            <section class="mb-12">
                <h2 class="text-xl md:text-2xl font-bold text-cyan-300 text-center mb-4">Current Activity</h2>
                <div id="current-activity-container" class="space-y-4">
                    <!-- Dynamic content inserted here -->
                </div>
            </section>
            
            <!-- Quick Links/Student Services Section -->
            <section class="mb-12">
                <h2 class="text-xl md:text-2xl font-bold text-cyan-300 text-center mb-6">Student Services</h2>
                <div class="portal-links-container">
                    <button id="attendance-btn" class="portal-btn px-6 py-3 rounded-full text-lg glow-container">
                        <span class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle-2"><path d="M12 2a10 10 0 1 0 10 10a10 10 0 0 0-10-10Z"/><path d="M9 12l2 2l4-4"/></svg>
                            Attendance Portal
                        </span>
                    </button>
                    <button id="mess-btn" class="portal-btn px-6 py-3 rounded-full text-lg glow-container">
                        <span class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chef-hat"><path d="M17.5 22h-.5c-.2 0-.4-.1-.5-.3L12 14v-3c0-.4-.3-.7-.7-.9l4-1.6c.7-.3 1.3-.8 1.6-1.5c.3-.8.4-1.8.2-2.7a3.5 3.5 0 0 1 3.5-3.5h0a3.5 3.5 0 0 1 3.5 3.5c-.2.9-.1 1.9.2 2.7c.3.7.9 1.2 1.6 1.5L24 11v3l-4.5 7.7c-.1.2-.3.3-.5.3z"/><path d="M6 14v-3c0-.4-.3-.7-.7-.9l-4-1.6C.6 7.2 0 6.7.2 6c.2-.9.4-1.9.2-2.7a3.5 3.5 0 0 1 3.5-3.5h0a3.5 3.5 0 0 1 3.5 3.5c-.2.9-.1 1.9.2 2.7c.3.7.9 1.2 1.6 1.5L12 11v3l-4.5 7.7c-.1.2-.3.3-.5.3z"/><path d="M12 11h-.01"/></svg>
                            Mess Menu
                        </span>
                    </button>
                    <!-- New button for AI Assistant -->
                    <button id="ai-help-btn" class="portal-btn px-6 py-3 rounded-full text-lg glow-container">
                        <span class="flex items-center gap-2">
                            <i class="fas fa-robot text-lg"></i>
                            AI Sahayak ‚ú®
                        </span>
                    </button>
                    <button id="discussion-btn" class="portal-btn px-6 py-3 rounded-full text-lg glow-container">
                        <span class="flex items-center gap-2">
                            <i class="fas fa-comments text-lg"></i>
                            Discussion Room
                        </span>
                    </button>
                </div>
            </section>
            
            <!-- Upcoming Events & Timetable Section -->
            <section class="mb-12">
                <h2 class="text-xl md:text-2xl font-bold text-cyan-300 text-center mb-4">Upcoming Events & Schedule</h2>
                <div id="events-container" class="space-y-4">
                    <!-- Single event will be dynamically inserted here -->
                </div>
            </section>

            <!-- Subjects Section (Dynamic) -->
            <section id="subjects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <!-- Subject cards will be dynamically inserted here by JavaScript -->
            </section>

        </main>

        <!-- Footer -->
        <footer class="bg-gray-900 shadow-2xl rounded-t-3xl mx-4 my-4 p-4 md:mx-10 md:my-10 md:p-6 lg:mx-20 lg:my-12 lg:p-8 text-center text-gray-500 text-sm transition-all duration-300">
            <p>Made with ‚ù§Ô∏è by Aditya Pandey</p>
        </footer>
    </div>

    <!-- Timetable Modal -->
    <div id="timetable-modal" class="modal">
        <div class="modal-content md:p-8 p-4">
            <span class="close-btn" id="close-modal-btn">&times;</span>
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-cyan-300 text-center">Class Timetable</h2>
            <div id="timetable-content" class="overflow-y-auto w-full h-full">
                <!-- Timetable will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Upcoming Events Modal -->
    <div id="events-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-events-modal-btn">&times;</span>
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-cyan-300 text-center">Upcoming Events</h2>
            <div id="all-events-container" class="space-y-4 overflow-y-auto">
                <!-- All events will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Material Selection Modal -->
    <div id="material-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-material-modal-btn">&times;</span>
            <h2 id="material-modal-title" class="text-xl md:text-2xl font-bold mb-4 text-cyan-300 text-center">Select Material</h2>
            <div id="material-buttons-container" class="material-buttons-container">
                <!-- Material buttons will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Iframe Portal Modal -->
    <div id="portal-modal" class="modal">
        <div class="modal-content full-screen-modal-content">
            <span class="close-btn" id="close-portal-btn">&times;</span>
            <div class="loader-container" id="portal-loader">
                <div class="loader"></div>
                <div class="mt-4">Loading...</div>
            </div>
            <iframe id="portal-iframe" src="" frameborder="0" class="w-full h-full"></iframe>
        </div>
    </div>

    <!-- Discussion Room Modal -->
    <div id="discussion-modal" class="modal">
        <div class="modal-content flex flex-col">
            <span class="close-btn" id="close-discussion-modal">&times;</span>
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-cyan-300 text-center">Discussion Room</h2>
            <div id="chat-messages" class="flex-grow p-4 bg-gray-900 rounded-lg border border-gray-700 mb-4 scrollbar-hide">
                <!-- Chat messages will appear here -->
            </div>
            <form id="chat-form" class="flex gap-4">
                <input type="text" id="chat-input" placeholder="Type your message..." class="w-full px-4 py-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-400" autocomplete="off">
                <button type="submit" id="send-chat-btn" class="portal-btn text-base p-2 px-6 glow-container">Send</button>
            </form>
        </div>
    </div>

    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBZwtYb6cif230DFeWYod5Kd_UDQ5cqz8I",
            authDomain: "jiit-a2-portal.firebaseapp.com",
            projectId: "jiit-a2-portal",
            storageBucket: "jiit-a2-portal.firebasestorage.app",
            messagingSenderId: "747985862248",
            appId: "1:747985862248:web:db7d2f5eeea03f952085dd",
            measurementId: "G-X339YN0MDV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables for data from Firebase
        let subjects = [];
        let events = [];
        
        // Timetable data (can also be moved to Firebase later if needed)
        const timetableData = [
             {
                day: 'Monday',
                classes: [
                    { time: '10:00 AM - 11:00 AM', subject: 'Physics', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'lime' },
                    { time: '11:00 AM - 12:00 PM', subject: 'Maths', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'pink' },
                    { time: '12:00 PM - 1:00 PM', subject: 'Break', type: '', icon: '‚òï', color: 'gray' },
                    { time: '1:00 PM - 3:00 PM', subject: 'Physics', type: 'Lab', icon: 'üî¨', color: 'lime' },
                    { time: '3:00 PM - 5:00 PM', subject: 'Basic Electronics', type: 'Lab', icon: 'üî¨', color: 'red' },
                ]
            },
            {
                day: 'Tuesday',
                classes: [
                    { time: '9:00 AM - 10:00 AM', subject: 'Physics', type: 'Tutorial', icon: 'üó£Ô∏è', color: 'lime' },
                    { time: '10:00 AM - 11:00 AM', subject: 'Basic Electronics', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'red' },
                    { time: '11:00 AM - 12:00 PM', subject: 'SDF', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'orange' },
                    { time: '12:00 PM - 1:00 PM', subject: 'Break', type: '', icon: '‚òï', color: 'gray' },
                    { time: '1:00 PM - 4:00 PM', subject: 'Engineering Drawing', type: 'Lab', icon: 'üî¨', color: 'yellow' },
                ]
            },
            {
                day: 'Wednesday',
                classes: [
                    { time: '10:00 AM - 11:00 AM', subject: 'English', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'teal' },
                    { time: '11:00 AM - 12:00 PM', subject: 'Basic Electronics', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'red' },
                    { time: '12:00 PM - 1:00 PM', subject: 'Break', type: '', icon: '‚òï', color: 'gray' },
                    { time: '1:00 PM - 3:00 PM', subject: 'English', type: 'Lab', icon: 'üî¨', color: 'teal' },
                    { time: '3:00 PM - 4:00 PM', subject: 'SDF', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'orange' },
                ]
            },
            {
                day: 'Thursday',
                classes: [
                    { time: '9:00 AM - 11:00 AM', subject: 'SDF', type: 'Lab', icon: 'üî¨', color: 'orange' },
                    { time: '11:00 AM - 1:00 PM', subject: 'Break', type: '', icon: '‚òï', color: 'gray' },
                    { time: '1:00 PM - 2:00 PM', subject: 'Physics', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'lime' },
                    { time: '2:00 PM - 3:00 PM', subject: 'Maths', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'pink' },
                ]
            },
            {
                day: 'Friday',
                classes: [
                    { time: '9:00 AM - 10:00 AM', subject: 'Maths', type: 'Tutorial', icon: 'üó£Ô∏è', color: 'pink' },
                    { time: '10:00 AM - 11:00 AM', subject: 'Basic Electronics', type: 'Tutorial', icon: 'üó£Ô∏è', color: 'red' },
                    { time: '11:00 AM - 12:00 PM', subject: 'Physics', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'lime' },
                    { time: '12:00 PM - 1:00 PM', subject: 'Break', type: '', icon: '‚òï', color: 'gray' },
                    { time: '1:00 PM - 2:00 PM', subject: 'Maths', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'pink' },
                    { time: '2:00 PM - 3:00 PM', subject: 'SDF', type: 'Tutorial', icon: 'üó£Ô∏è', color: 'orange' },
                    { time: '3:00 PM - 4:00 PM', subject: 'Basic Electronics', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'red' },
                    { time: '4:00 PM - 5:00 PM', subject: 'SDF', type: 'Lecture', icon: 'üë®‚Äçüè´', color: 'orange' },
                ]
            },
            { day: 'Saturday', classes: [] },
            { day: 'Sunday', classes: [] }
        ];

        // Element references
        const portalContent = document.getElementById('portal-content');
        const subjectsContainer = document.getElementById('subjects-container');
        const eventsContainer = document.getElementById('events-container');
        const allEventsContainer = document.getElementById('all-events-container');
        const clockElement = document.getElementById('clock');
        const showTimetableBtn = document.getElementById('show-timetable-btn');
        const timetableModal = document.getElementById('timetable-modal');
        const eventsModal = document.getElementById('events-modal');
        const materialModal = document.getElementById('material-modal');
        const loginModal = document.getElementById('login-modal');
        const closeTimetableBtn = document.getElementById('close-modal-btn');
        const closeEventsBtn = document.getElementById('close-events-modal-btn');
        const closeMaterialBtn = document.getElementById('close-material-modal-btn');
        const timetableContent = document.getElementById('timetable-content');
        const materialButtonsContainer = document.getElementById('material-buttons-container');
        const materialModalTitle = document.getElementById('material-modal-title');
        const welcomeMessage = document.getElementById('welcome-message');
        const attendanceBtn = document.getElementById('attendance-btn');
        const messBtn = document.getElementById('mess-btn');
        const portalModal = document.getElementById('portal-modal');
        const portalIframe = document.getElementById('portal-iframe');
        const closePortalBtn = document.getElementById('close-portal-btn');
        const portalLoader = document.getElementById('portal-loader');
        const currentActivityContainer = document.getElementById('current-activity-container');
        const announcementsContainer = document.getElementById('announcements-container');
        
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginMessageBox = document.getElementById('login-message-box');
        
        const bellButton = document.getElementById('bell-button');
        const popUp = document.getElementById('announcement-pop-up');
        const closeButton = document.getElementById('close-button');

        const aiHelpBtn = document.getElementById('ai-help-btn');
        const aiHelpModal = document.getElementById('ai-help-modal');
        const closeAiModalBtn = document.getElementById('close-ai-modal');
        const aiInput = document.getElementById('ai-input');
        const aiGenerateBtn = document.getElementById('ai-generate-btn');
        const aiClearBtn = document.getElementById('ai-clear-btn');
        const aiResponseContainer = document.getElementById('ai-response-container');
        const aiLoader = document.getElementById('ai-loader');

        const logoutBtn = document.getElementById('logout-btn');

        const discussionBtn = document.getElementById('discussion-btn');
        const discussionModal = document.getElementById('discussion-modal');
        const closeDiscussionModalBtn = document.getElementById('close-discussion-modal');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');

        // State variables
        let currentEventIndex = 0;
        let eventInterval;
        let currentSubject = '';
        let currentMaterialType = '';
        let timetableInterval;
        let currentActivityInterval;
        let unsubscribeChat; // To stop listening to chat messages when modal is closed
        
        // --- Data Fetching from Firebase ---
        async function fetchSubjects() {
            try {
                const querySnapshot = await getDocs(collection(db, "subjects"));
                subjects = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSubjects();
            } catch (e) {
                console.error("Error fetching subjects: ", e);
                subjectsContainer.innerHTML = `<p class="text-center text-red-400 col-span-full">Could not load subjects. Ensure Firestore is set up correctly.</p>`;
            }
        }

        async function fetchEvents() {
            try {
                const querySnapshot = await getDocs(collection(db, "events"));
                events = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (events.length > 0) {
                    if(eventInterval) clearInterval(eventInterval);
                    renderSingleEvent();
                    eventInterval = setInterval(renderSingleEvent, 2000);
                } else {
                     renderSingleEvent();
                }
            } catch(e) {
                console.error("Error fetching events: ", e);
                eventsContainer.innerHTML = `<div class="bg-gray-800 p-4 rounded-lg text-center text-red-400">Could not load events.</div>`;
            }
        }

        async function fetchAnnouncements() {
            try {
                const querySnapshot = await getDocs(collection(db, "announcements"));
                const announcements = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAnnouncements(announcements);
            } catch(e) {
                console.error("Error fetching announcements: ", e);
                announcementsContainer.innerHTML = `<div class="p-4 bg-red-900 rounded-lg border border-red-700"><p class="text-red-300">Could not load announcements.</p></div>`;
            }
        }

        // --- Rendering Functions ---
        const updateClock = () => {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            clockElement.textContent = time;
        };
        setInterval(updateClock, 1000);

        const parseTime = (timeStr) => {
            const now = new Date();
            const [startStr, endStr] = timeStr.split(' - ').map(s => s.trim());

            const parseSingleTime = (t) => {
                const timeParts = t.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                if (!timeParts) return null;

                let hour = parseInt(timeParts[1], 10);
                const minute = parseInt(timeParts[2], 10);
                const period = timeParts[3] ? timeParts[3].toUpperCase() : null;

                if (period === 'PM' && hour !== 12) {
                    hour += 12;
                } else if (period === 'AM' && hour === 12) {
                    hour = 0; // Midnight case
                }
                
                return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);
            };

            const start = parseSingleTime(startStr);
            const end = parseSingleTime(endStr);
            
            if (!start || !end) return { start: new Date(0), end: new Date(0) };

            return { start, end };
        };

        const renderCurrentActivity = () => {
            const now = new Date();
            const currentDayOfWeek = now.toLocaleString('en-US', { weekday: 'long' });
            const todayTimetable = timetableData.find(d => d.day === currentDayOfWeek);
            let currentActivity = null;
            let upcomingActivity = null;
            
            if (todayTimetable) {
                currentActivity = todayTimetable.classes.find(cls => {
                    const { start, end } = parseTime(cls.time);
                    return now >= start && now < end;
                });
                
                if (!currentActivity) {
                    upcomingActivity = todayTimetable.classes.find(cls => {
                        const { start } = parseTime(cls.time);
                        return now < start;
                    });
                }
            }

            if (currentActivity) {
                currentActivityContainer.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg border border-gray-700 animated-event current-class-glow"><div class="flex items-center space-x-4"><span class="text-3xl">${currentActivity.icon}</span><div><h3 class="font-semibold text-white text-xl">Current Class: ${currentActivity.subject}</h3><p class="text-sm text-gray-400">${currentActivity.type}</p><p class="text-sm text-gray-500">${currentActivity.time}</p></div></div></div>`;
                showTimetableBtn.classList.add('glow-container');
            } else if (upcomingActivity) {
                currentActivityContainer.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg border border-gray-700 animated-event"><div class="flex items-center space-x-4"><span class="text-3xl">${upcomingActivity.icon}</span><div><h3 class="font-semibold text-white text-xl">Upcoming: ${upcomingActivity.subject}</h3><p class="text-sm text-gray-400">${upcomingActivity.type}</p><p class="text-sm text-gray-500">${upcomingActivity.time}</p></div></div></div>`;
                showTimetableBtn.classList.add('glow-container');
            } else {
                currentActivityContainer.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg border border-gray-700 animated-event text-center"><p class="text-lg text-gray-400">No classes are scheduled at this time.</p></div>`;
                showTimetableBtn.classList.remove('glow-container');
            }
        };

        const renderSingleEvent = () => {
            if (events.length === 0) {
                eventsContainer.innerHTML = `<div class="bg-gray-800 p-4 rounded-lg text-center text-gray-400">No upcoming events.</div>`;
                return;
            }
            eventsContainer.innerHTML = '';
            const event = events[currentEventIndex];
            const eventCard = document.createElement('div');
            eventCard.className = 'bg-gray-800 p-4 rounded-lg flex items-center single-event-card border border-gray-700 hover:bg-gray-700 transition-colors duration-200 animated-event';
            eventCard.innerHTML = `<div class="flex-grow"><h3 class="font-semibold text-gray-200">${event.title}</h3><p class="text-sm text-gray-400">${event.date} ${event.time || ''}</p></div>`;
            eventsContainer.appendChild(eventCard);
            currentEventIndex = (currentEventIndex + 1) % events.length;
        };

        const renderAllEvents = () => {
            allEventsContainer.innerHTML = '';
             if (events.length === 0) {
                allEventsContainer.innerHTML = `<div class="bg-gray-800 p-4 rounded-lg text-center text-gray-400">No upcoming events.</div>`;
                return;
            }
            events.forEach(event => {
                const eventCard = document.createElement('div');
                eventCard.className = 'bg-gray-800 p-4 rounded-lg flex items-center event-card border border-gray-700 hover:bg-gray-700 transition-colors duration-200';
                eventCard.innerHTML = `<div class="flex-grow"><h3 class="font-semibold text-gray-200">${event.title}</h3><p class="text-sm text-gray-400">${event.date} ${event.time || ''}</p></div>`;
                allEventsContainer.appendChild(eventCard);
            });
        };
        
        const renderAnnouncements = (announcements) => {
            announcementsContainer.innerHTML = '';
            if (announcements.length === 0) {
                announcementsContainer.innerHTML = `<div class="p-4 bg-gray-800 rounded-lg border border-gray-700"><p class="text-gray-300">No new announcements.</p></div>`;
                return;
            }
            announcements.forEach(ann => {
                const annDiv = document.createElement('div');
                annDiv.className = `p-4 bg-${ann.color}-900 rounded-lg border border-${ann.color}-700`;
                annDiv.innerHTML = `<p class="text-sm text-${ann.color}-300 font-semibold">${ann.title.toUpperCase()}</p><p class="text-gray-300">${ann.message}</p>`;
                announcementsContainer.appendChild(annDiv);
            });
        };

        const createSubjectCard = (subject) => {
            return `
                <div class="bg-gray-900 p-6 rounded-2xl border border-gray-700 futuristic-card">
                    <h2 class="text-2xl md:text-3xl font-bold mb-4 ${subject.color} subject-title">${subject.name}</h2>
                    <div class="space-y-4">
                        <div class="bg-gray-800 rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition-colors duration-200 material-link" data-subject="${subject.name}" data-type="notes">
                            <h3 class="text-lg font-semibold text-white">Lecture Notes</h3>
                            <p class="text-sm text-gray-400">Notes, videos, and presentations.</p>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition-colors duration-200 material-link" data-subject="${subject.name}" data-type="labs">
                            <h3 class="text-lg font-semibold text-white">Lab Work</h3>
                            <p class="text-sm text-gray-400">Manuals, simulations, and reports.</p>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition-colors duration-200 material-link" data-subject="${subject.name}" data-type="tutorials">
                            <h3 class="text-lg font-semibold text-white">Tutorials</h3>
                            <p class="text-sm text-gray-400">Problem sheets and solution guides.</p>
                        </div>
                    </div>
                </div>`;
        };

        const renderSubjects = () => {
            subjectsContainer.innerHTML = '';
            subjects.forEach((subject, index) => {
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = createSubjectCard(subject).trim();
                const cardElement = tempContainer.firstChild;
                subjectsContainer.appendChild(cardElement);
                setTimeout(() => cardElement.classList.add('animate-in'), index * 100);
            });
        };

        const updateWelcomeMessage = (name) => {
            welcomeMessage.textContent = name ? `Welcome, ${name}!` : `Welcome, Student!`;
        };

        const renderTimetable = (selectedDay) => {
            const now = new Date();
            const currentDayOfWeek = now.toLocaleString('en-US', { weekday: 'long' });
            
            const selectedDayData = timetableData.find(d => d.day === selectedDay);
            const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayButtons = daysOfWeek.map(day => `<button class="day-btn text-xs md:text-sm px-2 py-1 flex-shrink-0 ${day === selectedDay ? 'active' : ''}" data-day="${day}">${day.substring(0, 3)}</button>`).join('');

            let classCardsHTML = '<div class="text-center py-8"><p class="text-lg text-gray-400">No classes are scheduled for today.</p></div>';

            if (selectedDayData && selectedDayData.classes.length > 0) {
                const isCurrentDay = (selectedDay === currentDayOfWeek);
                let upcomingClassIndex = -1;

                if (isCurrentDay) {
                    for (let i = 0; i < selectedDayData.classes.length; i++) {
                        const { start, end } = parseTime(selectedDayData.classes[i].time);
                        if (now >= start && now < end) {
                            upcomingClassIndex = -2; 
                            break;
                        }
                        if (now < start && upcomingClassIndex === -1) {
                            upcomingClassIndex = i;
                        }
                    }
                }

                classCardsHTML = selectedDayData.classes.map((cls, index) => {
                    const { start, end } = parseTime(cls.time);
                    const isCurrentClass = isCurrentDay && (now >= start && now < end);
                    const isUpcomingClass = isCurrentDay && (index === upcomingClassIndex);
                    
                    let glowClass = '';
                    if (isCurrentClass) glowClass = 'current-class-glow';
                    else if (isUpcomingClass) glowClass = 'upcoming-class-glow';

                    return `<div class="bg-gray-900 rounded-lg p-3 text-sm md:text-base flex items-center justify-between border-l-4 border-${cls.color}-400 ${glowClass}"><div><p class="font-medium text-white">${cls.subject} <span class="text-gray-400 font-normal">(${cls.type || ''})</span></p><p class="text-xs text-gray-500">${cls.time}</p></div><span class="text-xl">${cls.icon}</span></div>`;
                }).join('');
            }

            timetableContent.innerHTML = `
                <div class="flex overflow-x-auto whitespace-nowrap space-x-2 pb-2 mb-4 scrollbar-hide" id="day-buttons-container">${dayButtons}</div>
                <div class="p-4 rounded-xl shadow-xl border border-gray-700 bg-gray-800">
                    <h3 class="text-xl font-bold text-center mb-4 text-cyan-300">${selectedDay}</h3>
                    <div class="space-y-3">${classCardsHTML}</div>
                </div>`;
        };
        
        const startTimetableUpdates = () => {
            if (timetableInterval) clearInterval(timetableInterval);
            timetableInterval = setInterval(() => {
                const activeDayBtn = document.querySelector('.day-btn.active');
                if (activeDayBtn) {
                     renderTimetable(activeDayBtn.dataset.day);
                }
            }, 60000);
        };

        // --- Event Listeners ---
        showTimetableBtn.addEventListener('click', () => {
            const currentDayOfWeek = new Date().toLocaleString('en-US', { weekday: 'long' });
            renderTimetable(currentDayOfWeek);
            timetableModal.classList.add('active');
            startTimetableUpdates();
        });
        
        attendanceBtn.addEventListener('click', () => openPortalModal('https://jportal2-0.vercel.app/#/attendance'));
        messBtn.addEventListener('click', () => openPortalModal('https://mess-schedule.vercel.app/'));

        aiHelpBtn.addEventListener('click', () => {
            aiHelpModal.classList.add('active');
            aiResponseContainer.textContent = 'Jawaab yahan dikhayega...';
            aiInput.value = '';
        });

        const openPortalModal = (url) => {
            portalIframe.src = url;
            portalModal.classList.add('active');
            portalLoader.style.display = 'flex';
            portalIframe.onload = () => portalLoader.style.display = 'none';
        };

        eventsContainer.addEventListener('click', () => {
            renderAllEvents();
            eventsModal.classList.add('active');
        });
        
        document.addEventListener('click', (event) => {
            if (event.target.classList.contains('day-btn')) {
                renderTimetable(event.target.dataset.day);
                startTimetableUpdates();
            }
        });
        
        document.addEventListener('click', (event) => {
            const materialLink = event.target.closest('.material-link');
            if (materialLink) {
                const subjectName = materialLink.dataset.subject;
                const type = materialLink.dataset.type;
                const subjectData = subjects.find(s => s.name === subjectName);
                if (subjectData) {
                    openMaterialModal(subjectData, type);
                }
            }
            
            const materialBtn = event.target.closest('.chapter-btn');
            if (materialBtn) {
                const driveLink = materialBtn.dataset.link;
                if (driveLink) {
                    window.open(driveLink, '_blank');
                    materialModal.classList.remove('active');
                }
            }
        });
        
        const openMaterialModal = (subjectData, materialType) => {
            currentSubject = subjectData.name;
            currentMaterialType = materialType;
            materialButtonsContainer.innerHTML = '';
            
            const materials = subjectData[materialType];
            materialModalTitle.textContent = `Select Material for ${subjectData.name} (${materialType})`;

            if (materials && Object.keys(materials).length > 0) {
                 Object.entries(materials).forEach(([key, value]) => {
                    const materialBtn = document.createElement('button');
                    materialBtn.className = 'chapter-btn';
                    materialBtn.textContent = key;
                    materialBtn.dataset.link = value;
                    materialButtonsContainer.appendChild(materialBtn);
                });
            } else {
                materialButtonsContainer.innerHTML = `<p class="text-gray-400">No materials available for this section.</p>`;
            }
            
            materialModal.classList.add('active');
        };

        loginForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            loginMessageBox.textContent = '';
            loginMessageBox.classList.remove('error', 'success', 'hidden');
            
            if (username === '') {
                loginMessageBox.classList.add('error', 'bg-red-500', 'text-white', 'p-2', 'rounded');
                loginMessageBox.textContent = 'Please enter your full name.';
            } else if (password === 'A2PORTAL') {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('userName', username);
                loginModal.classList.remove('active');
                showPortalContent();
            } else {
                loginMessageBox.classList.add('error', 'bg-red-500', 'text-white', 'p-2', 'rounded');
                loginMessageBox.textContent = 'Incorrect credentials.';
            }
        });
        
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userName');
            location.reload();
        });

        const showPortalContent = () => {
            portalContent.style.display = 'flex';
            updateWelcomeMessage(localStorage.getItem('userName'));
            updateClock();
            renderCurrentActivity();
            currentActivityInterval = setInterval(renderCurrentActivity, 30000);
            
            // Fetch dynamic content
            fetchSubjects();
            fetchEvents();
            fetchAnnouncements();
        };

        // --- Modal Close Listeners ---
        [closeTimetableBtn, closeEventsBtn, closeMaterialBtn, closeAiModalBtn, closeDiscussionModalBtn, closePortalBtn].forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.modal').classList.remove('active');
                 if (btn === closeTimetableBtn) clearInterval(timetableInterval);
                 if (btn === closeDiscussionModalBtn && unsubscribeChat) unsubscribeChat();
                 if (btn === closePortalBtn) portalIframe.src = "";
            });
        });

        aiClearBtn.addEventListener('click', () => {
            aiInput.value = '';
            aiResponseContainer.textContent = 'Jawaab yahan dikhayega...';
        });

        aiGenerateBtn.addEventListener('click', async () => {
             const userQuery = aiInput.value.trim();
            if (userQuery === '') {
                aiResponseContainer.textContent = 'Kripya apna prashna likhein.';
                return;
            }

            aiLoader.style.display = 'flex';
            aiResponseContainer.textContent = '';

            const systemPrompt = "Aap ek sahayak student assistant hain, jo college ke vidyarthiyon ko unki padhai aur anya kaamon mein madad karne ke liye banaya gaya hai. Aapko unke prashnon ka jawaab Hindi (Latin) mein dena hai. Apne jawaab ko sahi dhang se format karein (HTML tags ka upyog na karein).";
            
            const apiKey = ""; // You can add your Gemini API key here if you have one.
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    aiResponseContainer.textContent = text;
                } else {
                    aiResponseContainer.textContent = 'Jawaab prapt karne mein koi dikkat hui. Kripya phir se koshish karein.';
                }

            } catch (error) {
                console.error("API Error:", error);
                aiResponseContainer.textContent = 'Maaf kijiye, ek error aayi. Kripya thodi der baad phir se koshish karein.';
            } finally {
                aiLoader.style.display = 'none';
            }
        });

        // --- Real-time Discussion Room Logic ---
        const renderChat = (messages) => {
            chatMessagesContainer.innerHTML = '';
            const loggedInUser = localStorage.getItem('userName');
            messages.forEach(msg => {
                const isOwnMessage = msg.name === loggedInUser;
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isOwnMessage ? 'chat-message-own' : 'chat-message-other'}`;
                messageDiv.innerHTML = `<p class="sender-name">${isOwnMessage ? 'You' : msg.name}</p><p>${msg.text}</p>`;
                chatMessagesContainer.appendChild(messageDiv);
            });
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        };

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            const name = localStorage.getItem('userName');
            if (text && name) {
                chatInput.value = '';
                await addDoc(collection(db, "chatMessages"), {
                    name: name,
                    text: text,
                    timestamp: new Date()
                });
            }
        });
        
        discussionBtn.addEventListener('click', () => {
            discussionModal.classList.add('active');
            const q = query(collection(db, "chatMessages"), orderBy("timestamp", "desc"), limit(10));
            unsubscribeChat = onSnapshot(q, (querySnapshot) => {
                const messages = [];
                querySnapshot.forEach((doc) => {
                    messages.push(doc.data());
                });
                renderChat(messages.reverse());
            });
        });
        
        bellButton.addEventListener('click', () => {
            const isHidden = popUp.style.display === 'none' || popUp.style.display === '';
            popUp.style.animation = isHidden ? 'slideDown 0.3s ease-out' : 'slideUp 0.3s ease-in-out';
            if (isHidden) popUp.style.display = 'flex';
            else setTimeout(() => { popUp.style.display = 'none'; }, 250);
        });

        closeButton.addEventListener('click', () => {
            popUp.style.animation = 'slideUp 0.3s ease-in-out';
            setTimeout(() => { popUp.style.display = 'none'; }, 250);
        });

        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
                if (event.target === timetableModal) clearInterval(timetableInterval);
                if (event.target === discussionModal && unsubscribeChat) unsubscribeChat();
                if (event.target === portalModal) portalIframe.src = "";
            }

            const clickedInsidePopup = popUp.contains(event.target);
            const clickedBell = bellButton.contains(event.target);
            if (popUp.style.display === 'flex' && !clickedInsidePopup && !clickedBell) {
                popUp.style.animation = 'slideUp 0.3s ease-in-out';
                setTimeout(() => { popUp.style.display = 'none'; }, 250);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('isLoggedIn') === 'true') {
                loginModal.classList.remove('active');
                showPortalContent();
                setTimeout(() => {
                    bellButton.click();
                    setTimeout(() => bellButton.click(), 5000);
                }, 2000);
            } else {
                loginModal.classList.add('active');
            }
        });
    </script>
</body>
</html>
