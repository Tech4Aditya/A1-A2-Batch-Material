<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>JIIT A2 Study Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #e2e8f0;
            overflow-x: hidden;
        }
        .futuristic-card {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(25, 179, 219, 0.1);
            opacity: 0;
            transform: translateY(30px);
        }
        .futuristic-card:hover {
            box-shadow: 0 0 30px rgba(25, 179, 219, 0.4);
            transform: translateY(-5px);
        }
        .futuristic-card.animate-in {
            opacity: 1;
            transform: translateY(0);
        }
        .header-glow {
            box-shadow: 0 0 40px rgba(74, 144, 226, 0.3);
        }
        .subject-title {
            text-shadow: 0 0 10px currentColor;
        }
        .semester-btn, .chapter-btn, .day-btn, .portal-btn {
            background-color: #1f2937;
            color: #d1d5db;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            border: 1px solid #4b5563;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .semester-btn:hover, .chapter-btn:hover, .day-btn:hover, .portal-btn:hover {
            background-color: #2d3748;
            color: #ffffff;
            border-color: #06b6d4;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .semester-btn:active, .chapter-btn:active, .day-btn:active, .portal-btn:active {
            transform: translateY(0px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .day-btn.active {
            background-color: #06b6d4;
            color: #ffffff;
            border-color: #06b6d4;
            box-shadow: 0 0 10px #06b6d4;
        }
        .semester-dropdown {
            background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #2d3748;
            box-shadow: 8px 30px rgba(0, 0, 0, 0.6);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .semester-dropdown.active {
            max-height: 500px;
        }
        .fade-out {
            transition: all 0.6s ease-out;
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
        }
        /* Aesthetic Clock and Button Styling */
        .glow-container {
            background-color: #1a202c;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.5);
            border: 1px solid rgba(6, 182, 212, 0.5);
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(6, 182, 212, 0.5); }
            50% { box-shadow: 0 0 25px rgba(6, 182, 212, 0.8); }
        }
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            position: relative;
            background-color: #1a202c;
            margin: 1.5rem;
            padding: 1.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 1200px;
            height: 90%;
            box-shadow: 0 0 40px rgba(6, 182, 212, 0.5);
            animation: modal-fade-in 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }
        @keyframes modal-fade-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .login-modal-content, .password-modal-content, .announcement-modal-content, .planner-modal-content, .gpa-modal-content, .notepad-modal-content {
            width: 95%;
            max-width: 500px;
            height: auto;
            padding: 2rem;
            background-color: #1a202c;
            box-shadow: 0 0 40px rgba(6, 182, 212, 0.5);
        }
        .full-screen-modal-content {
            width: 100%;
            max-width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            border-radius: 0;
            background-color: #0d1117;
            box-shadow: none;
        }
        .full-screen-modal-content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #d1d5db;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10;
        }
        .close-btn:hover {
            color: #ef4444;
        }
        
        .single-event-card {
            cursor: pointer;
            transition: transform 0.3s ease-in-out;
        }
        .single-event-card:hover {
            transform: scale(1.02);
        }

        /* New Futuristic Animation */
        .animated-event {
            animation: futuristicReveal 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes futuristicReveal {
            0% { opacity: 0; transform: translateY(20px) scale(0.9); box-shadow: 0 0 0px rgba(6, 182, 212, 0); }
            100% { opacity: 1; transform: translateY(0) scale(1); box-shadow: 0 0 15px rgba(6, 182, 212, 0.5); }
        }

        /* Chapter Buttons */
        .material-buttons-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        #portal-content {
            display: none;
        }

        .message-box {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 101;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: all 0.3s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        .message-box.show {
            transform: translateY(0);
            opacity: 1;
        }
        .current-class-glow {
            animation: pulse-glow 1.5s infinite;
        }
        .upcoming-class-glow {
            animation: pulse-glow-upcoming 1.5s infinite;
        }
        @keyframes pulse-glow-upcoming {
            0%, 100% { box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); }
            50% { box-shadow: 0 0 25px rgba(251, 191, 36, 0.8); }
        }
        
        /* Flashing glow for the next upcoming event */
        .upcoming-event-glow {
             animation: flash-glow 1s infinite;
        }
        @keyframes flash-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(234, 179, 8, 0.4); border-color: rgba(234, 179, 8, 0.4); }
            50% { box-shadow: 0 0 25px rgba(234, 179, 8, 0.8); border-color: rgba(234, 179, 8, 0.8); }
        }
        
        /* Hide scrollbar for a cleaner look */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .loader-container {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(13, 17, 23, 0.95);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: #6ee7b7;
            font-size: 1.25rem;
        }
        .loader {
            border: 4px solid rgba(6, 182, 212, 0.3);
            border-radius: 50%;
            border-top: 4px solid #6ee7b7;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes shake {
            0% { transform: rotate(0deg); }
            20% { transform: rotate(-15deg); }
            40% { transform: rotate(15deg); }
            60% { transform: rotate(-10deg); }
            80% { transform: rotate(10deg); }
            100% { transform: rotate(0deg); }
        }
        #bell-button i {
            animation: shake 1.2s infinite ease-in-out;
            transform-origin: top center;
        }

        .pop-up {
            position: absolute;
            top: 70px;
            right: 20px;
            transform: none;
            z-index: 110;
            display: none;
        }
        #announcement-pop-up {
            display: none; 
        }
        .pop-up-content {
            width: 90%;
            max-width: 500px;
            height: auto;
            padding: 2rem;
            background-color: #1a202c;
            box-shadow: 0 0 40px rgba(6, 182, 212, 0.5);
            border-radius: 1rem;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* Discussion Room specific styling */
        #chat-messages {
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 80%;
            display: flex;
            flex-direction: column;
            line-height: 1.5;
        }
        .chat-message .sender-name {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .chat-message-other {
            background-color: #374151;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        .chat-message-own {
            background-color: #1d4ed8;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        
        /* New Events Roadmap Styling */
        #roadmap-container {
            position: relative;
            width: 100%;
            padding: 2rem 0;
            flex-grow: 1;
            overflow-y: auto;
        }
        .timeline {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
        }
        .timeline::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: #4b5563;
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -3px;
            border-radius: 3px;
        }
        .timeline-item {
            padding: 10px 40px;
            position: relative;
            background-color: inherit;
            width: 50%;
        }
        .timeline-item.left {
            left: 0;
        }
        .timeline-item.right {
            left: 50%;
        }
        .timeline-item::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            right: -17px;
            background-color: #1f2937;
            border: 4px solid #06b6d4;
            top: 15px;
            border-radius: 50%;
            z-index: 1;
        }
        .timeline-item.right::after {
            left: -16px;
        }
        .timeline-content {
            padding: 1rem 1.25rem;
            background-color: #1f2937;
            position: relative;
            border-radius: 8px;
            border: 1px solid #4b5563;
        }
        .timeline-item.past-event .timeline-content {
            opacity: 0.5;
            border-left: 5px solid #6b7280; /* Gray for past */
        }
        .timeline-item.upcoming-event .timeline-content {
            border-left: 5px solid #f59e0b; /* Amber for upcoming */
        }
        .timeline-item.today-event .timeline-content {
            border-left: 5px solid #22c55e; /* Green for today */
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        /* New Countdown Styles */
        #countdown-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        .countdown-item {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .countdown-time {
            font-size: 1.5rem;
            font-weight: 700;
            color: #38bdf8; /* Light Blue */
            letter-spacing: 0.05em;
        }
        .countdown-label {
            font-size: 0.75rem;
            color: #94a3b8; /* Slate 400 */
            text-transform: uppercase;
        }
        .countdown-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        /* New Planner Styles */
        #task-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .task-item {
            transition: all 0.3s ease;
        }
        .task-item.completed {
            opacity: 0.5;
        }
        .task-item.completed p {
            text-decoration: line-through;
        }

        /* GPA Calculator Styles */
        #gpa-subject-rows {
            max-height: 300px;
            overflow-y: auto;
        }

        /* New Toolkit Styles */
        .toolkit-card {
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .toolkit-card:hover {
            transform: translateY(-5px);
            background-color: #334155;
            border-color: #06b6d4;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
        }
        .toolkit-card i {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }
        .toolkit-card h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        /* Media query for mobile timeline */
        @media screen and (max-width: 768px) {
            .timeline::after {
                left: 31px; /* Move the line to the left */
            }
            .timeline-item {
                width: 100%;
                padding-left: 70px; /* Make space for line and icon */
                padding-right: 15px;
            }
            .timeline-item.left, .timeline-item.right {
                left: 0%; /* Stack all items */
            }
            .timeline-item.right::after, .timeline-item.left::after {
                left: 15px; /* Position icon on the line */
            }
            .timeline-content {
                padding: 1rem;
            }
            .timeline-content h3 {
                font-size: 1rem;
            }
        }

        /* Welcome Animation */
        #welcome-overlay {
            transition: opacity 1s ease-in-out;
            display: none; /* Hide by default */
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            to { opacity: 0; }
        }

    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- New Welcome Animation Overlay -->
    <div id="welcome-overlay" class="fixed inset-0 bg-[#0d1117] flex items-center justify-center z-[200] pointer-events-none">
        <h1 class="text-4xl md:text-5xl font-bold text-white">
            <span id="welcome-text-anim" class="opacity-0">Welcome, </span><span id="welcome-name-anim" class="opacity-0 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-lime-500"></span>
        </h1>
    </div>

    <!-- The bell icon button -->
    <button id="bell-button" class="fixed top-6 right-6 p-4 bg-gray-900 text-gray-200 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-cyan-300 z-50">
        <i class="fas fa-bell text-2xl"></i>
    </button>
    
    <!-- The new announcement pop-up window -->
    <div id="announcement-pop-up" class="pop-up">
        <div id="announcement-content" class="pop-up-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-cyan-300">Important Announcements</h2>
                <button id="close-button" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="announcements-container" class="space-y-4">
                <!-- Announcements from Firebase will be loaded here -->
            </div>
            
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal active">
        <div class="modal-content login-modal-content flex flex-col items-center justify-center">
            <h2 class="text-2xl font-bold mb-4 text-cyan-300 text-center">Portal Login</h2>
            <p class="text-sm text-gray-400 mb-6 text-center">Enter your name and password to log in.</p>
            <form id="login-form" class="space-y-4 w-full">
                <div>
                    <input type="text" id="username" placeholder="Enter Full Name" class="w-full px-4 py-2 my-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-400" required>
                </div>
                <div>
                    <input type="password" id="password" placeholder="Enter Password" class="w-full px-4 py-2 my-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-400" required>
                </div>
                <button type="submit" class="portal-btn text-base p-2 w-full glow-container mt-4">
                    Log In
                </button>
            </form>
            <div id="login-message-box" class="message-box hidden mt-4 text-center"></div>
        </div>
    </div>
    
    <div id="portal-content" class="flex flex-col min-h-screen">
        <!-- Header with Clock and Timetable button -->
        <header class="bg-gray-900 header-glow rounded-b-3xl mx-4 mt-4 p-4 md:p-6 transition-all duration-300 flex flex-col sm:flex-row justify-between items-center flex-wrap gap-4">
            <div class="flex-grow">
                <h2 id="user-name-display" class="text-lg md:text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-lime-500 text-center sm:text-left opacity-0 transition-opacity duration-1000"></h2>
                <h1 class="text-2xl sm:text-4xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 text-center sm:text-left">
                    JIIT A2 Study Portal
                </h1>
            </div>
            <div class="flex items-center gap-2 sm:gap-4 mt-4 sm:mt-0 flex-wrap justify-center">
                 <button id="logout-btn" class="semester-btn text-sm sm:text-base py-2 px-4 bg-red-800/50 border-red-500/50 hover:bg-red-700/50">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
                <button id="show-timetable-btn" class="semester-btn text-sm sm:text-base py-2 px-4">
                    View Timetable
                </button>
                <div id="clock" class="text-base sm:text-xl font-bold text-gray-300 glow-container whitespace-nowrap"></div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main id="main-content" class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8 md:py-12 transition-all duration-500 ease-out">
            
            <!-- Current Activity Section -->
            <section class="mb-10 md:mb-12">
                <h2 class="text-xl md:text-2xl font-bold text-cyan-300 text-center mb-4">Current Activity</h2>
                <div id="current-activity-container" class="space-y-4"></div>
            </section>

            <!-- Countdown Timer Section -->
            <section id="countdown-container" class="mb-10 md:mb-12"></section>

            <!-- Upcoming Schedule and Toolkit Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10 md:mb-12">
                <section>
                    <h2 class="text-xl md:text-2xl font-bold text-cyan-300 text-center mb-6">Upcoming Schedule</h2>
                    <div id="events-container" class="space-y-4"></div>
                </section>
                <section>
                     <h2 class="text-xl md:text-2xl font-bold text-cyan-300 text-center mb-6">Student Toolkit</h2>
                     <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div id="planner-btn" class="toolkit-card"><i class="fas fa-tasks text-yellow-400"></i><h3>Planner</h3></div>
                        <div id="notepad-btn" class="toolkit-card"><i class="fas fa-sticky-note text-indigo-400"></i><h3>Quick Note</h3></div>
                        <div id="gpa-btn" class="toolkit-card"><i class="fas fa-calculator text-pink-400"></i><h3>GPA Calc</h3></div>
                        <div id="attendance-btn" class="toolkit-card"><i class="fas fa-check-circle text-green-400"></i><h3>Attendance</h3></div>
                        <div id="mess-btn" class="toolkit-card"><i class="fas fa-utensils text-orange-400"></i><h3>Mess Menu</h3></div>
                        <div id="discussion-btn" class="toolkit-card"><i class="fas fa-comments text-purple-400"></i><h3>Discussion</h3></div>
                     </div>
                </section>
            </div>

            <!-- Subjects Section (Dynamic) -->
            <section id="subjects-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8">
                <!-- Subject cards will be dynamically inserted here by JavaScript -->
            </section>

        </main>

        <!-- Footer -->
        <footer class="bg-gray-900 shadow-2xl rounded-t-3xl mx-4 my-4 p-4 md:p-6 text-center text-gray-500 text-sm transition-all duration-300">
            <p>Made with ❤️ by Aditya Pandey</p>
        </footer>
    </div>

    <!-- ALL MODALS BELOW -->
    <div id="timetable-modal" class="modal">
        <div class="modal-content md:p-8 p-4">
            <span class="close-btn">&times;</span>
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-cyan-300 text-center">Class Timetable</h2>
            <div id="timetable-content" class="overflow-y-auto w-full h-full"></div>
        </div>
    </div>

    <div id="roadmap-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="flex justify-between items-center mb-4 px-2 sm:px-6 pt-2">
                <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-cyan-300">Academic Roadmap</h2>
                <button id="toggle-past-events" class="portal-btn text-xs sm:text-sm py-2 px-4">Show Past Events</button>
            </div>
            <div id="roadmap-container" class="scrollbar-hide">
                 <div class="timeline"></div>
            </div>
        </div>
    </div>

    <div id="material-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="material-modal-title" class="text-xl md:text-2xl font-bold mb-4 text-cyan-300 text-center">Select Material</h2>
            <div id="material-buttons-container" class="material-buttons-container"></div>
        </div>
    </div>

    <div id="portal-modal" class="modal">
        <div class="modal-content full-screen-modal-content">
            <span class="close-btn">&times;</span>
            <div class="loader-container" id="portal-loader">
                <div class="loader"></div>
                <div class="mt-4">Loading...</div>
            </div>
            <iframe id="portal-iframe" src="" frameborder="0" class="w-full h-full"></iframe>
        </div>
    </div>

    <div id="discussion-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-cyan-300 text-center">Group Chat</h2>
            <div id="chat-messages-wrapper" class="flex-grow p-4 bg-gray-900 rounded-lg border border-gray-700 mb-4 scrollbar-hide overflow-y-auto">
                 <div id="chat-messages" class="h-full"></div>
            </div>
            <form id="chat-form" class="flex gap-4">
                <input type="text" id="chat-input" placeholder="Type your message..." class="w-full px-4 py-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-400" autocomplete="off">
                <button type="submit" id="send-chat-btn" class="portal-btn text-base p-2 px-6 glow-container">Send</button>
            </form>
        </div>
    </div>
    
    <!-- New Planner Modal -->
    <div id="planner-modal" class="modal">
        <div class="modal-content planner-modal-content">
            <span class="close-btn">&times;</span>
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-cyan-300 text-center">Study Planner</h2>
            <form id="task-form" class="flex gap-2 mb-4">
                <input type="text" id="task-input" placeholder="Enter a new task..." class="w-full px-4 py-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-400" required>
                <button type="submit" class="portal-btn !px-6">Add</button>
            </form>
            <div id="task-list" class="space-y-3 p-2"></div>
        </div>
    </div>
    
    <!-- New GPA Calculator Modal -->
    <div id="gpa-modal" class="modal">
        <div class="modal-content gpa-modal-content">
            <span class="close-btn">&times;</span>
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-cyan-300 text-center">GPA Calculator</h2>
             <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="current-cgpa" class="block text-sm font-medium text-gray-400">Current CGPA</label>
                    <input type="number" step="0.01" id="current-cgpa" class="w-full mt-1 px-3 py-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700">
                </div>
                 <div>
                    <label for="credits-done" class="block text-sm font-medium text-gray-400">Credits Completed</label>
                    <input type="number" id="credits-done" class="w-full mt-1 px-3 py-2 rounded-lg bg-gray-800 text-gray-200 border border-gray-700">
                </div>
            </div>
            <h3 class="font-semibold text-center mb-2">Current Semester Subjects</h3>
            <div id="gpa-subject-rows" class="space-y-2 mb-4 p-2"></div>
            <button id="add-subject-row" class="portal-btn text-sm w-full mb-4">Add Subject</button>
            <div id="gpa-results" class="text-center bg-gray-900 p-4 rounded-lg"></div>
        </div>
    </div>

    <!-- New Notepad Modal -->
    <div id="notepad-modal" class="modal">
        <div class="modal-content notepad-modal-content">
            <span class="close-btn">&times;</span>
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-cyan-300 text-center">Quick Note Pad</h2>
            <p class="text-xs text-center text-gray-500 mb-2">Your note is saved automatically.</p>
            <textarea id="notepad-input" class="w-full h-64 p-4 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-400 resize-none" placeholder="Jot down your thoughts..."></textarea>
            <div id="notepad-status" class="text-center text-xs text-green-400 mt-2 h-4"></div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, addDoc, query, orderBy, limit, doc, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBZwtYb6cif230DFeWYod5Kd_UDQ5cqz8I",
            authDomain: "jiit-a2-portal.firebaseapp.com",
            projectId: "jiit-a2-portal",
            storageBucket: "jiit-a2-portal.firebasestorage.app",
            messagingSenderId: "747985862248",
            appId: "1:747985862248:web:db7d2f5eeea03f952085dd",
            measurementId: "G-X339YN0MDV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables for data from Firebase
        let subjects = [];
        
        // --- Hardcoded Data ---
        const academicCalendar = [
            { title: 'Registration of 1st Semester (B.Tech, Intgt M.Tech, All UG and Diploma)', fullDate: 'July 10 2025', displayDate: 'July 10', category: 'Deadline' },
            { title: 'Induction Program and Commencement of Academic Activities for UG 1st Year', fullDate: 'July 11 2025', displayDate: 'July 11', category: 'Event' },
            { title: '(B) Existing PhD Scholars - Registration', fullDate: 'July 21 2025', displayDate: 'July 21', category: 'Deadline' },
            { title: 'Registration of 1st Semester (All PG Programs and Lateral Entry)', fullDate: 'July 24 2025', displayDate: 'July 24', category: 'Deadline' },
            { title: 'Registration All students except 1st Semester (Online)', fullDate: 'July 24 2025', displayDate: 'July 24', category: 'Deadline' },
            { title: 'Commencement of Classes for all batches (except 1st Sem UG Program)', fullDate: 'July 24 2025', displayDate: 'July 24', category: 'Event' },
            { title: '(A) Ph.D New Admissions July 2025 : Enrollment', fullDate: 'July 29 2025', displayDate: 'July 29', category: 'Deadline' },
            { title: 'Last date to exercise options for Add & Drop Subjects (except 1st Semester students)', fullDate: 'July 31 2025', displayDate: 'July 31', category: 'Deadline' },
            { title: '(A) Ph.D New Admissions July 2025 : Orientation', fullDate: 'July 31 2025', displayDate: 'July 31', category: 'Event' },
            { title: 'Deactivation of Un-Registered Students', fullDate: 'August 1 2025', displayDate: 'August 1', category: 'Deadline' },
            { title: 'DPMAC Meeting and Completion of follow-up Registration requirements', fullDate: 'August 2 2025', displayDate: 'August 2', category: 'Event' },
            { title: '(A) Ph.D New Admissions July 2025 : Registration', fullDate: 'August 4 2025', displayDate: 'August 4', category: 'Deadline' },
            { title: 'Last Date for Registration of MOOC subject on web-portal', fullDate: 'August 7 2025', displayDate: 'August 7', category: 'Deadline' },
            { title: 'Rakshabandhan', fullDate: 'August 9 2025', displayDate: 'August 9', category: 'Holiday' },
            { title: 'Independence Day', fullDate: 'August 15 2025', displayDate: 'August 15', category: 'Holiday' },
            { title: 'Janmashtami', fullDate: 'August 16 2025', displayDate: 'August 16', category: 'Holiday' },
            { title: 'Ebullience/Welcome function of 1st year students', fullDate: 'August 23 2025', displayDate: 'August 23', category: 'Event' },
            { title: 'Attendance Review before T1 exam', fullDate: 'August 27 2025', displayDate: 'August 27', category: 'Deadline' },
            { title: 'T1 Examination', fullDate: 'August 29 2025', displayDate: 'Aug 29 → Sep 6', category: 'Exam' },
            { title: 'Showing of Evaluated Answer Sheets to students (Latest by)', fullDate: 'September 12 2025', displayDate: 'September 12', category: 'Deadline' },
            { title: 'T1 Results (Latest by)', fullDate: 'September 15 2025', displayDate: 'September 15', category: 'Result' },
            { title: 'Summer Training Viva - Locking of Marks', fullDate: 'September 16 2025', displayDate: 'September 16', category: 'Viva' },
            { title: 'Gandhi Jayanti / Dussehra', fullDate: 'October 2 2025', displayDate: 'October 2', category: 'Holiday' },
            { title: 'Allocation of Topics for Seminar/Term Paper for M.Tech 3rd Sem', fullDate: 'October 8 2025', displayDate: 'October 8', category: 'Deadline' },
            { title: 'Attendance Review before T2 exam', fullDate: 'October 8 2025', displayDate: 'October 8', category: 'Deadline' },
            { title: 'Lab/Projects - Mid Term Seminars / Vivas - Results to be uploaded by', fullDate: 'October 10 2025', displayDate: 'October 10', category: 'Deadline' },
            { title: 'Mid Term (T2) Examination', fullDate: 'October 10 2025', displayDate: 'Oct 10 → Oct 18', category: 'Exam' },
            { title: 'Semester Break - Diwali (Odd)', fullDate: 'October 19 2025', displayDate: 'Oct 19 → Oct 26', category: 'Holiday' },
            { title: 'Student Vacation (Mid-semester break (Diwali))', fullDate: 'October 19 2025', displayDate: 'Oct 19 → Oct 26', category: 'Holiday' },
            { title: 'Final List of Electives to be sent to Registrar\'s Office', fullDate: 'October 20 2025', displayDate: 'October 20', category: 'Deadline' },
            { title: 'Deepawali', fullDate: 'October 20 2025', displayDate: 'Oct 20 → Oct 21', category: 'Holiday' },
            { title: 'Faculty Vacation (Diwali)', fullDate: 'October 20 2025', displayDate: 'Oct 20 → Oct 25', category: 'Holiday' },
            { title: 'Sharing draft curriculum with Dean (A&R)-2', fullDate: 'October 22 2025', displayDate: 'October 22', category: 'Deadline' },
            { title: 'Govardhan Puja', fullDate: 'October 22 2025', displayDate: 'October 22', category: 'Holiday' },
            { title: 'Finalized curriculum to be entered in ERP system', fullDate: 'October 23 2025', displayDate: 'Oct 23 → Oct 28', category: 'Deadline' },
            { title: 'Showing of Evaluated Answer Sheets to students (Latest by)', fullDate: 'October 31 2025', displayDate: 'October 31', category: 'Deadline' },
            { title: 'T2 Results (Latest by)', fullDate: 'November 3 2025', displayDate: 'November 3', category: 'Result' },
            { title: 'Orientation program for electives', fullDate: 'November 5 2025', displayDate: 'Nov 5 → Nov 7', category: 'Event' },
            { title: 'Guru Nanak Jayanti', fullDate: 'November 5 2025', displayDate: 'November 5', category: 'Holiday' },
            { title: 'Pre-Registration by students through webportal', fullDate: 'November 8 2025', displayDate: 'Nov 8 → Nov 11', category: 'Deadline' },
            { title: 'Make-up Examination (All)', fullDate: 'November 11 2025', displayDate: 'Nov 11 → Nov 15', category: 'Exam' },
            { title: 'Major/Minor Project allocation', fullDate: 'November 18 2025', displayDate: 'November 18', category: 'Deadline' },
            { title: 'Final Project Viva / End-Term Seminar', fullDate: 'November 20 2025', displayDate: 'November 20', category: 'Viva' },
            { title: 'Students\' Online Feed Back Collection by', fullDate: 'November 21 2025', displayDate: 'November 21', category: 'Deadline' },
            { title: 'Submission of Project/Dissertation reports', fullDate: 'November 25 2025', displayDate: 'November 25', category: 'Deadline' },
            { title: 'End Semester Attendance Review', fullDate: 'November 25 2025', displayDate: 'November 25', category: 'Deadline' },
            { title: 'Classes to be over', fullDate: 'November 28 2025', displayDate: 'November 28', category: 'Deadline' },
            { title: 'Meeting of Time Table Committee', fullDate: 'November 28 2025', displayDate: 'November 28', category: 'Event' },
            { title: 'Debar list to be displayed', fullDate: 'November 29 2025', displayDate: 'November 29', category: 'Deadline' },
            { title: 'Lab/Minor Projects - End Term Vivas - Results uploaded by', fullDate: 'December 1 2025', displayDate: 'December 1', category: 'Deadline' },
            { title: 'End Semester Examination', fullDate: 'December 1 2025', displayDate: 'Dec 1 → Dec 13', category: 'Exam' },
            { title: 'Minor projects results shared with students', fullDate: 'December 14 2025', displayDate: 'December 14', category: 'Event' },
            { title: 'Semester Break', fullDate: 'December 14 2025', displayDate: 'Dec 14 → Jan 1', category: 'Holiday' },
            { title: 'Student Vacation', fullDate: 'December 14 2025', displayDate: 'Dec 14 → Jan 1', category: 'Holiday' },
            { title: 'Showing of Evaluated Answer Sheets to students by', fullDate: 'December 17 2025', displayDate: 'December 17', category: 'Deadline' },
            { title: 'Meeting of IAMC for results', fullDate: 'December 19 2025', displayDate: 'December 19', category: 'Event' },
            { title: 'Provisional Grades Display', fullDate: 'December 19 2025', displayDate: 'December 19', category: 'Event' },
            { title: 'JIIT Alumni Meet', fullDate: 'December 20 2025', displayDate: 'December 20', category: 'Event' },
            { title: 'Freezing the grades/Submission of Final Grades', fullDate: 'December 20 2025', displayDate: 'December 20', category: 'Deadline' },
            { title: 'End Sem Results', fullDate: 'December 22 2025', displayDate: 'December 22', category: 'Result' },
            { title: 'Supplementary Examination - Registration', fullDate: 'December 22 2025', displayDate: 'Dec 22 → Dec 24', category: 'Deadline' },
            { title: 'Christmas', fullDate: 'December 25 2025', displayDate: 'December 25', category: 'Holiday' },
            { title: 'Faculty Vacation (Winter)', fullDate: 'December 25 2025', displayDate: 'Dec 25 → Jan 1', category: 'Holiday' },
            { title: 'Supplementary Exam Schedule', fullDate: 'December 29 2025', displayDate: 'Dec 29 → Dec 31', category: 'Exam' },
            { title: 'IAMC meeting for finalization Suppl. Results', fullDate: 'January 2 2026', displayDate: 'January 2', category: 'Event' },
            { title: 'Commencement of Next Semester', fullDate: 'January 2 2026', displayDate: 'January 2', category: 'Event' },
            { title: 'Registration of 1st Semester (All PG Programs and Lateral Entry)', fullDate: 'January 2 2026', displayDate: 'January 2', category: 'Deadline' },
            { title: 'Registration All students except 1st Semester (Online)', fullDate: 'January 2 2026', displayDate: 'January 2', category: 'Deadline' },
            { title: 'Commencement of Classes for all batches (except 1st Sem UG Program)', fullDate: 'January 2 2026', displayDate: 'January 2', category: 'Event' },
            { title: 'Submission of Suppl. Exam Grades by Faculty and Freezing', fullDate: 'January 3 2026', displayDate: 'January 3', category: 'Deadline' },
            { title: '(B) Existing PhD Scholars - Registration', fullDate: 'January 4 2026', displayDate: 'January 4', category: 'Deadline' },
            { title: 'Decl. of Results of Suppl. Exam', fullDate: 'January 5 2026', displayDate: 'January 5', category: 'Event' },
            { title: 'Registration of 1st Semester (B.Tech, Intgt M.Tech, All UG and Diploma)', fullDate: 'January 5 2026', displayDate: 'January 5', category: 'Deadline' },
            { title: 'Last date to exercise options for Add & Drop Subjects (except 1st Semester students)', fullDate: 'January 9 2026', displayDate: 'January 9', category: 'Deadline' },
            { title: 'Deactivation of Un-Registered Students', fullDate: 'January 10 2026', displayDate: 'January 10', category: 'Deadline' },
            { title: 'Last Date for Registration of MOOC subject on web-portal', fullDate: 'January 16 2026', displayDate: 'January 16', category: 'Deadline' },
            { title: 'Republic day', fullDate: 'January 26 2026', displayDate: 'January 26', category: 'Holiday' },
            { title: 'JYC Function', fullDate: 'February 6 2026', displayDate: 'Feb 6 → Feb 8', category: 'Event' },
            { title: 'Attendance Review before T1 exam', fullDate: 'February 8 2026', displayDate: 'February 8', category: 'Deadline' },
            { title: 'T1 Examination & Results - Examination Schedule', fullDate: 'February 10 2026', displayDate: 'Feb 10 → Feb 18', category: 'Exam' },
            { title: 'Maha Shivratri', fullDate: 'February 15 2026', displayDate: 'February 15', category: 'Holiday' },
            { title: 'Showing of Evaluated Answer Sheets to students (Latest by)', fullDate: 'February 24 2026', displayDate: 'February 24', category: 'Deadline' },
            { title: 'Results Uploading on System (Latest by)', fullDate: 'February 28 2026', displayDate: 'February 28', category: 'Deadline' },
            { title: 'Semester Break - Holi (Even)', fullDate: 'March 1 2026', displayDate: 'Mar 1 → Mar 8', category: 'Holiday' },
            { title: 'Student Vacation (Mid-semester break (Holi))', fullDate: 'March 1 2026', displayDate: 'Mar 1 → Mar 8', category: 'Holiday' },
            { title: 'Faculty Vacation (Holi)', fullDate: 'March 2 2026', displayDate: 'Mar 2 → Mar 7', category: 'Holiday' },
            { title: 'Holi', fullDate: 'March 3 2026', displayDate: 'Mar 3 → Mar 4', category: 'Holiday' },
            { title: 'Eid-Ul-Fitr*', fullDate: 'March 21 2026', displayDate: 'March 21', category: 'Holiday' },
            { title: 'Attendance Review before T2 exam', fullDate: 'March 22 2026', displayDate: 'March 22', category: 'Deadline' },
            { title: 'Lab/Projects - Mid Term Seminars / Vivas - Results to be uploaded by', fullDate: 'March 24 2026', displayDate: 'March 24', category: 'Deadline' },
            { title: 'Mid Term/ T2 Examination & Results - Examination Schedule', fullDate: 'March 24 2026', displayDate: 'Mar 24 → Apr 2', category: 'Exam' },
            { title: 'Ram Navami', fullDate: 'March 26 2026', displayDate: 'March 26', category: 'Holiday' },
            { title: 'Mahavir Jayanti', fullDate: 'March 31 2026', displayDate: 'March 31', category: 'Holiday' },
            { title: 'Final List of Electives to be sent to Registrar\'s Office', fullDate: 'April 4 2026', displayDate: 'April 4', category: 'Deadline' },
            { title: 'Sharing draft curriculum with Dean (A&R)-2', fullDate: 'April 6 2026', displayDate: 'April 6', category: 'Deadline' },
            { title: 'Finalized curriculum (including electives) to be entered in ERP system', fullDate: 'April 7 2026', displayDate: 'Apr 7 → Apr 11', category: 'Deadline' },
            { title: 'Showing of Evaluated Answer Sheets to students (Latest by)', fullDate: 'April 8 2026', displayDate: 'April 8', category: 'Deadline' },
            { title: 'Results Uploading on System (Latest by)', fullDate: 'April 11 2026', displayDate: 'April 11', category: 'Deadline' },
            { title: 'Ambedkar Jayanti', fullDate: 'April 14 2026', displayDate: 'April 14', category: 'Holiday' },
            { title: 'Orientation program by the department/s to help students to select electives', fullDate: 'April 15 2026', displayDate: 'Apr 15 → Apr 17', category: 'Event' },
            { title: 'Pre-Registration by students through webportal', fullDate: 'April 18 2026', displayDate: 'Apr 18 → Apr 21', category: 'Deadline' },
            { title: 'Summer Semester - 2026 - List of subjects to be offered in Summer Semester to be forwarded to Registrar\'s Office', fullDate: 'April 20 2026', displayDate: 'April 20', category: 'Deadline' },
            { title: 'Make-up Examination (All)', fullDate: 'April 21 2026', displayDate: 'Apr 21 → Apr 25', category: 'Exam' },
            { title: 'Major Project allocation for next year by', fullDate: 'April 22 2026', displayDate: 'April 22', category: 'Deadline' },
            { title: 'Minor Project allocation for next semester by', fullDate: 'April 22 2026', displayDate: 'April 22', category: 'Deadline' },
            { title: 'Summer Semester notice to Website', fullDate: 'April 24 2026', displayDate: 'April 24', category: 'Event' },
            { title: 'Fee payment and Subject Registration by Students', fullDate: 'April 27 2026', displayDate: 'Apr 27 → May 2', category: 'Deadline' },
            { title: 'Students\' Online Feed Back Collection by', fullDate: 'May 1 2026', displayDate: 'May 1', category: 'Deadline' },
            { title: 'Budh Purnima', fullDate: 'May 1 2026', displayDate: 'May 1', category: 'Holiday' },
            { title: 'List of Registered students to be forwarded to Dean (A&R-2)', fullDate: 'May 5 2026', displayDate: 'May 5', category: 'Deadline' },
            { title: 'End Semester Attendance Review', fullDate: 'May 6 2026', displayDate: 'May 6', category: 'Deadline' },
            { title: 'Submission of Project (B.Tech & M.Tech)/ Dissertation reports (M.Tech)/ Term Paper (M.Tech)', fullDate: 'May 7 2026', displayDate: 'May 7', category: 'Deadline' },
            { title: 'Classes to be over', fullDate: 'May 8 2026', displayDate: 'May 8', category: 'Deadline' },
            { title: 'Debar list to be displayed', fullDate: 'May 8 2026', displayDate: 'May 8', category: 'Deadline' },
            { title: 'Display of Final list of subjects to students', fullDate: 'May 8 2026', displayDate: 'May 8', category: 'Event' },
            { title: 'Meeting of Time Table Committee for courses of next semester', fullDate: 'May 9 2026', displayDate: 'May 9', category: 'Event' },
            { title: 'Lab/Minor Projects - End Term Seminars / Vivas - Results uploaded by', fullDate: 'May 11 2026', displayDate: 'May 11', category: 'Deadline' },
            { title: 'End Semester Examination', fullDate: 'May 11 2026', displayDate: 'May 11 → May 23', category: 'Exam' },
            { title: 'Time Table for Summer Semester', fullDate: 'May 18 2026', displayDate: 'May 18', category: 'Event' },
            { title: 'Meeting of Disciplinary Committee (Disciplinary Grade Finalization)', fullDate: 'May 25 2026', displayDate: 'May 25', category: 'Event' },
            { title: 'Showing of Evaluated Answer Sheets to students by', fullDate: 'May 27 2026', displayDate: 'May 27', category: 'Deadline' },
            { title: 'Vacations & Summer Internship - Semester Break', fullDate: 'May 27 2026', displayDate: 'May 27 → Jul 24', category: 'Holiday' },
            { title: 'Student Vacation (Summer Vacation)', fullDate: 'May 27 2026', displayDate: 'May 27 → Jul 22', category: 'Holiday' },
            { title: 'Summer Internship (Industrial Trg) Period', fullDate: 'May 28 2026', displayDate: 'May 28 → Jul 8', category: 'Event' },
            { title: 'Meeting of IAMC for results of all courses', fullDate: 'May 29 2026', displayDate: 'May 29', category: 'Event' },
            { title: 'Provisional Grades Display', fullDate: 'May 29 2026', displayDate: 'May 29', category: 'Event' },
            { title: 'The results of minor projects after finalization through institutional committee to be shared with students and those failing to qualify should be given additional time', fullDate: 'May 30 2026', displayDate: 'May 30', category: 'Event' },
            { title: 'Freezing the grades/Submission of Final Grades to Registrar', fullDate: 'May 30 2026', displayDate: 'May 30', category: 'Deadline' },
            { title: 'Publish of Results by Registrar', fullDate: 'June 1 2026', displayDate: 'June 1', category: 'Event' },
            { title: 'Supplementary Examination - Registration for Supl Exam', fullDate: 'June 1 2026', displayDate: 'Jun 1 → Jun 3', category: 'Deadline' },
            { title: 'Faculty Vacation (Summer)', fullDate: 'June 2 2026', displayDate: 'Jun 2 → Jul 9', category: 'Holiday' },
            { title: 'Supplementary Exam Schedule', fullDate: 'June 5 2026', displayDate: 'Jun 5 → Jun 8', category: 'Exam' },
            { title: 'Commencement of Classes', fullDate: 'June 5 2026', displayDate: 'June 5', category: 'Event' },
            { title: 'Re-opening of Registration for Summer Semester (for registering in backlog subjects on offer of current semester)', fullDate: 'June 6 2026', displayDate: 'Jun 6 → Jun 8', category: 'Deadline' },
            { title: 'IAMC meeting for finalization Suppl. Results', fullDate: 'June 11 2026', displayDate: 'June 11', category: 'Event' },
            { title: 'Submission of Suppl. Exam Grades by Faculty and Freezing', fullDate: 'June 13 2026', displayDate: 'June 13', category: 'Deadline' },
            { title: 'Decl. of Results of Suppl. Exam', fullDate: 'June 13 2026', displayDate: 'June 13', category: 'Event' },
            { title: 'Summer Semester Mid Term Test', fullDate: 'June 24 2026', displayDate: 'Jun 24 → Jun 26', category: 'Exam' },
            { title: 'Summer Semester End Term Test', fullDate: 'July 15 2026', displayDate: 'Jul 15 → Jul 17', category: 'Exam' },
            { title: 'Showing of answer scripts to the students', fullDate: 'July 20 2026', displayDate: 'July 20', category: 'Deadline' },
            { title: 'IAMC Meeting finalization of Result', fullDate: 'July 21 2026', displayDate: 'July 21', category: 'Event' },
            { title: 'Submission of Exam Grades by Faculty and Freezing', fullDate: 'July 22 2026', displayDate: 'July 22', category: 'Deadline' },
            { title: 'Declaration of result', fullDate: 'July 23 2026', displayDate: 'July 23', category: 'Event' },
            { title: 'Commencement of Next Semester', fullDate: 'July 23 2026', displayDate: 'July 23', category: 'Event' },
            { title: 'Finalization of progression of 1st yr students into 2nd yr. and their registration in relevant Sem.', fullDate: 'July 27 2026', displayDate: 'July 27', category: 'Deadline' },
        ]; 

        const timetableData = [
             {
                day: 'Monday',
                classes: [
                    { time: '10:00 AM - 11:00 AM', subject: 'Physics', type: 'Lecture', icon: '👨‍🏫', color: 'lime' },
                    { time: '11:00 AM - 12:00 PM', subject: 'Maths', type: 'Lecture', icon: '👨‍🏫', color: 'pink' },
                    { time: '12:00 PM - 1:00 PM', subject: 'Break', type: '', icon: '☕', color: 'gray' },
                    { time: '1:00 PM - 3:00 PM', subject: 'Physics', type: 'Lab', icon: '🔬', color: 'lime' },
                    { time: '3:00 PM - 5:00 PM', subject: 'Basic Electronics', type: 'Lab', icon: '🔬', color: 'red' },
                ]
            },
            {
                day: 'Tuesday',
                classes: [
                    { time: '9:00 AM - 10:00 AM', subject: 'Physics', type: 'Tutorial', icon: '🗣️', color: 'lime' },
                    { time: '10:00 AM - 11:00 AM', subject: 'Basic Electronics', type: 'Lecture', icon: '👨‍🏫', color: 'red' },
                    { time: '11:00 AM - 12:00 PM', subject: 'SDF', type: 'Lecture', icon: '👨‍🏫', color: 'orange' },
                    { time: '12:00 PM - 1:00 PM', subject: 'Break', type: '', icon: '☕', color: 'gray' },
                    { time: '1:00 PM - 4:00 PM', subject: 'Engineering Drawing', type: 'Lab', icon: '🔬', color: 'yellow' },
                ]
            },
            {
                day: 'Wednesday',
                classes: [
                    { time: '10:00 AM - 11:00 AM', subject: 'English', type: 'Lecture', icon: '👨‍🏫', color: 'teal' },
                    { time: '11:00 AM - 12:00 PM', subject: 'Basic Electronics', type: 'Lecture', icon: '👨‍🏫', color: 'red' },
                    { time: '12:00 PM - 1:00 PM', subject: 'Break', type: '', icon: '☕', color: 'gray' },
                    { time: '1:00 PM - 3:00 PM', subject: 'English', type: 'Lab', icon: '🔬', color: 'teal' },
                    { time: '3:00 PM - 4:00 PM', subject: 'SDF', type: 'Lecture', icon: '👨‍🏫', color: 'orange' },
                ]
            },
            {
                day: 'Thursday',
                classes: [
                    { time: '9:00 AM - 11:00 AM', subject: 'SDF', type: 'Lab', icon: '🔬', color: 'orange' },
                    { time: '11:00 AM - 1:00 PM', subject: 'Break', type: '', icon: '☕', color: 'gray' },
                    { time: '1:00 PM - 2:00 PM', subject: 'Physics', type: 'Lecture', icon: '👨‍🏫', color: 'lime' },
                    { time: '2:00 PM - 3:00 PM', subject: 'Maths', type: 'Lecture', icon: '👨‍🏫', color: 'pink' },
                ]
            },
            {
                day: 'Friday',
                classes: [
                    { time: '9:00 AM - 10:00 AM', subject: 'Maths', type: 'Tutorial', icon: '🗣️', color: 'pink' },
                    { time: '10:00 AM - 11:00 AM', subject: 'Basic Electronics', type: 'Tutorial', icon: '🗣️', color: 'red' },
                    { time: '11:00 AM - 12:00 PM', subject: 'Physics', type: 'Lecture', icon: '👨‍🏫', color: 'lime' },
                    { time: '12:00 PM - 1:00 PM', subject: 'Break', type: '', icon: '☕', color: 'gray' },
                    { time: '1:00 PM - 2:00 PM', subject: 'Maths', type: 'Lecture', icon: '👨‍🏫', color: 'pink' },
                    { time: '2:00 PM - 3:00 PM', subject: 'SDF', type: 'Tutorial', icon: '🗣️', color: 'orange' },
                    { time: '3:00 PM - 4:00 PM', subject: 'Basic Electronics', type: 'Lecture', icon: '👨‍🏫', color: 'red' },
                    { time: '4:00 PM - 5:00 PM', subject: 'SDF', type: 'Lecture', icon: '👨‍🏫', color: 'orange' },
                ]
            },
            { day: 'Saturday', classes: [] },
            { day: 'Sunday', classes: [] }
        ];

        // Element references
        const portalContent = document.getElementById('portal-content');
        const subjectsContainer = document.getElementById('subjects-container');
        const eventsContainer = document.getElementById('events-container');
        const clockElement = document.getElementById('clock');
        const showTimetableBtn = document.getElementById('show-timetable-btn');
        const timetableModal = document.getElementById('timetable-modal');
        const roadmapModal = document.getElementById('roadmap-modal');
        const materialModal = document.getElementById('material-modal');
        const loginModal = document.getElementById('login-modal');
        const togglePastEventsBtn = document.getElementById('toggle-past-events');
        const timetableContent = document.getElementById('timetable-content');
        const materialButtonsContainer = document.getElementById('material-buttons-container');
        const materialModalTitle = document.getElementById('material-modal-title');
        
        const portalModal = document.getElementById('portal-modal');
        const portalIframe = document.getElementById('portal-iframe');
        const portalLoader = document.getElementById('portal-loader');
        const currentActivityContainer = document.getElementById('current-activity-container');
        const announcementsContainer = document.getElementById('announcements-container');
        
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginMessageBox = document.getElementById('login-message-box');
        
        const bellButton = document.getElementById('bell-button');
        const popUp = document.getElementById('announcement-pop-up');
        const closeButton = document.getElementById('close-button');

        const logoutBtn = document.getElementById('logout-btn');

        const discussionModal = document.getElementById('discussion-modal');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        
        // New Element References
        const countdownContainer = document.getElementById('countdown-container');
        const plannerModal = document.getElementById('planner-modal');
        const gpaModal = document.getElementById('gpa-modal');
        const notepadModal = document.getElementById('notepad-modal');
        const taskForm = document.getElementById('task-form');
        const taskInput = document.getElementById('task-input');
        const taskList = document.getElementById('task-list');
        const gpaSubjectRows = document.getElementById('gpa-subject-rows');
        const addSubjectRowBtn = document.getElementById('add-subject-row');
        const gpaResults = document.getElementById('gpa-results');
        const notepadInput = document.getElementById('notepad-input');
        const notepadStatus = document.getElementById('notepad-status');


        // State variables
        let currentSubject = '';
        let currentMaterialType = '';
        let timetableInterval;
        let currentActivityInterval;
        let unsubscribeChat; 
        let unsubscribePlanner;
        let showPastEvents = false;
        let countdownInterval;
        let notepadSaveTimeout;

        // --- All Rendering Functions ---

        const renderCountdownTimers = () => {
            const now = new Date();
            const importantEventTitles = [
                'T1 Examination', 
                'Mid Term (T2) Examination', 
                'End Semester Examination',
                'T1 Results (Latest by)', 
                'T2 Results (Latest by)', 
                'End Sem Results'
            ];

            const upcomingEvents = academicCalendar
                .filter(e => importantEventTitles.includes(e.title) && new Date(e.fullDate) > now)
                
            countdownContainer.innerHTML = '';
            if (upcomingEvents.length === 0) {
                countdownContainer.innerHTML = '<p class="text-center text-gray-400 w-full">No major exams or results on the horizon. Enjoy the peace!</p>';
                return;
            }

            upcomingEvents.slice(0, 3).forEach(event => {
                const targetDate = new Date(event.fullDate);
                const totalSeconds = (targetDate - now) / 1000;
                
                if (totalSeconds < 0) return;

                const days = Math.floor(totalSeconds / 3600 / 24);
                const hours = Math.floor(totalSeconds / 3600) % 24;
                const minutes = Math.floor(totalSeconds / 60) % 60;
                const seconds = Math.floor(totalSeconds) % 60;

                const countdownEl = document.createElement('div');
                countdownEl.className = 'countdown-item flex-grow';
                countdownEl.innerHTML = `
                    <p class="countdown-title">${event.title}</p>
                    <div class="flex justify-center gap-4">
                        <div><div class="countdown-time">${String(days).padStart(2, '0')}</div><div class="countdown-label">Days</div></div>
                        <div><div class="countdown-time">${String(hours).padStart(2, '0')}</div><div class="countdown-label">Hrs</div></div>
                        <div><div class="countdown-time">${String(minutes).padStart(2, '0')}</div><div class="countdown-label">Min</div></div>
                        <div><div class="countdown-time">${String(seconds).padStart(2, '0')}</div><div class="countdown-label">Sec</div></div>
                    </div>
                `;
                countdownContainer.appendChild(countdownEl);
            });
        };

        const renderTasks = (tasks) => {
            taskList.innerHTML = '';
            if(tasks.length === 0){
                taskList.innerHTML = `<p class="text-center text-gray-500 p-4">No tasks yet. Add one to get started!</p>`;
                return;
            }
            tasks.sort((a, b) => a.createdAt - b.createdAt).forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = `task-item flex items-center justify-between p-3 bg-gray-900 rounded-lg ${task.completed ? 'completed' : ''}`;
                taskEl.dataset.id = task.id;
                taskEl.innerHTML = `
                    <div class="flex items-center gap-3">
                        <input type="checkbox" class="task-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-cyan-500 focus:ring-cyan-600" ${task.completed ? 'checked' : ''}>
                        <p class="text-gray-300">${task.text}</p>
                    </div>
                    <button class="delete-task text-gray-500 hover:text-red-500">&times;</button>
                `;
                taskList.appendChild(taskEl);
            });
        };

        // --- Data Fetching from Firebase ---
        async function fetchSubjects() {
            try {
                const subjectsRef = collection(db, "subjects");
                const q = query(subjectsRef, orderBy("order"));
                const querySnapshot = await getDocs(q);
                subjects = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSubjects();
            } catch (e) {
                console.error("Error fetching subjects: ", e);
                subjectsContainer.innerHTML = `<p class="text-center text-red-400 col-span-full">Could not load subjects. Ensure you have added an 'order' field (type: number) to each subject document in Firestore.</p>`;
            }
        }
        
        async function fetchAnnouncements() {
            try {
                const querySnapshot = await getDocs(collection(db, "announcements"));
                const announcements = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAnnouncements(announcements);
            } catch(e) {
                console.error("Error fetching announcements: ", e);
                announcementsContainer.innerHTML = `<div class="p-4 bg-red-900 rounded-lg border border-red-700"><p class="text-red-300">Could not load announcements.</p></div>`;
            }
        }

        // --- Core Rendering Functions ---
        const updateClock = () => {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            clockElement.textContent = time;
        };
        setInterval(updateClock, 1000);

        const parseTime = (timeStr) => {
            const now = new Date();
            const [startStr, endStr] = timeStr.split(' - ').map(s => s.trim());

            const parseSingleTime = (t) => {
                const timeParts = t.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                if (!timeParts) return null;

                let hour = parseInt(timeParts[1], 10);
                const minute = parseInt(timeParts[2], 10);
                const period = timeParts[3] ? timeParts[3].toUpperCase() : null;

                if (period === 'PM' && hour !== 12) {
                    hour += 12;
                } else if (period === 'AM' && hour === 12) {
                    hour = 0; // Midnight case
                }
                
                return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);
            };

            const start = parseSingleTime(startStr);
            const end = parseSingleTime(endStr);
            
            if (!start || !end) return { start: new Date(0), end: new Date(0) };

            return { start, end };
        };

        const renderCurrentActivity = () => {
            const now = new Date();
            const currentDayOfWeek = now.toLocaleString('en-US', { weekday: 'long' });
            const todayTimetable = timetableData.find(d => d.day === currentDayOfWeek);
            let currentActivity = null;
            let upcomingActivity = null;
            
            if (todayTimetable) {
                currentActivity = todayTimetable.classes.find(cls => {
                    const { start, end } = parseTime(cls.time);
                    return now >= start && now < end;
                });
                
                if (!currentActivity) {
                    upcomingActivity = todayTimetable.classes.find(cls => {
                        const { start } = parseTime(cls.time);
                        return now < start;
                    });
                }
            }

            if (currentActivity) {
                currentActivityContainer.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg border border-gray-700 animated-event current-class-glow"><div class="flex items-center space-x-4"><span class="text-3xl">${currentActivity.icon}</span><div><h3 class="font-semibold text-white text-xl">Current Class: ${currentActivity.subject}</h3><p class="text-sm text-gray-400">${currentActivity.type}</p><p class="text-sm text-gray-500">${currentActivity.time}</p></div></div></div>`;
                showTimetableBtn.classList.add('glow-container');
            } else if (upcomingActivity) {
                currentActivityContainer.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg border border-gray-700 animated-event"><div class="flex items-center space-x-4"><span class="text-3xl">${upcomingActivity.icon}</span><div><h3 class="font-semibold text-white text-xl">Upcoming: ${upcomingActivity.subject}</h3><p class="text-sm text-gray-400">${upcomingActivity.type}</p><p class="text-sm text-gray-500">${upcomingActivity.time}</p></div></div></div>`;
                showTimetableBtn.classList.add('glow-container');
            } else {
                currentActivityContainer.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg border border-gray-700 animated-event text-center"><p class="text-lg text-gray-400">No classes are scheduled at this time.</p></div>`;
                showTimetableBtn.classList.remove('glow-container');
            }
        };

        const renderUpcomingEventHighlight = () => {
            const now = new Date();
            now.setHours(0, 0, 0, 0); // Normalize to start of day for date comparison

            let nextEvent = null;

            for (const event of academicCalendar) {
                const eventDate = new Date(event.fullDate);
                if (eventDate >= now) {
                    nextEvent = event;
                    break;
                }
            }
            
            eventsContainer.innerHTML = '';
            if (nextEvent) {
                const eventCard = document.createElement('div');
                eventCard.className = 'bg-gray-800 p-4 rounded-lg flex items-center single-event-card border border-gray-700 hover:bg-gray-700 transition-colors duration-200 upcoming-event-glow';
                eventCard.innerHTML = `<div class="flex-grow"><h3 class="font-semibold text-gray-200">${nextEvent.title}</h3><p class="text-sm text-gray-400">${nextEvent.displayDate}</p></div>`;
                eventsContainer.appendChild(eventCard);
            } else {
                 eventsContainer.innerHTML = `<div class="bg-gray-800 p-4 rounded-lg text-center text-gray-400">No more events this semester.</div>`;
            }
        };
        
        const renderRoadmap = () => {
            const timelineContainer = document.querySelector('#roadmap-modal .timeline');
            timelineContainer.innerHTML = '';
            const now = new Date();
            now.setHours(0,0,0,0);

            const eventsToRender = showPastEvents ? academicCalendar : academicCalendar.filter(event => new Date(event.fullDate) >= now);

            const getIconForCategory = (category) => {
                switch (category) {
                    case 'Exam': return 'fas fa-pen-alt text-red-400';
                    case 'Holiday': return 'fas fa-glass-cheers text-green-400';
                    case 'Deadline': return 'fas fa-hourglass-half text-yellow-400';
                    case 'Viva': return 'fas fa-microphone-alt text-purple-400';
                    case 'Result': return 'fas fa-trophy text-amber-400';
                    default: return 'fas fa-calendar-check text-blue-400';
                }
            };

            eventsToRender.forEach((event, index) => {
                const eventDate = new Date(event.fullDate);
                const isPast = eventDate < now;
                const isToday = eventDate.toDateString() === now.toDateString();

                let statusClass = 'upcoming-event';
                if (isPast) statusClass = 'past-event';
                if (isToday) statusClass = 'today-event';
                
                const side = index % 2 === 0 ? 'left' : 'right';

                const item = document.createElement('div');
                item.className = `timeline-item ${side} ${statusClass}`;
                item.innerHTML = `
                    <div class="timeline-content">
                        <div class="flex items-center gap-4">
                            <i class="${getIconForCategory(event.category)} text-2xl"></i>
                            <div>
                                <h3 class="font-bold text-lg text-white">${event.title}</h3>
                                <p class="text-cyan-300 font-semibold">${event.displayDate}</p>
                            </div>
                        </div>
                    </div>
                `;
                timelineContainer.appendChild(item);
            });
        };
        
        const renderAnnouncements = (announcements) => {
            announcementsContainer.innerHTML = '';
            if (announcements.length === 0) {
                announcementsContainer.innerHTML = `<div class="p-4 bg-gray-800 rounded-lg border border-gray-700"><p class="text-gray-300">No new announcements.</p></div>`;
                return;
            }
            announcements.forEach(ann => {
                const annDiv = document.createElement('div');
                annDiv.className = `p-4 bg-${ann.color}-900 rounded-lg border border-${ann.color}-700`;
                annDiv.innerHTML = `<p class="text-sm text-${ann.color}-300 font-semibold">${ann.title.toUpperCase()}</p><p class="text-gray-300">${ann.message}</p>`;
                announcementsContainer.appendChild(annDiv);
            });
        };

        const createSubjectCard = (subject) => {
            return `
                <div class="bg-gray-900 p-6 rounded-2xl border border-gray-700 futuristic-card">
                    <h2 class="text-2xl md:text-3xl font-bold mb-4 ${subject.color} subject-title">${subject.name}</h2>
                    <div class="space-y-4">
                        <div class="bg-gray-800 rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition-colors duration-200 material-link" data-subject="${subject.name}" data-type="notes">
                            <h3 class="text-lg font-semibold text-white">Lecture Notes</h3>
                            <p class="text-sm text-gray-400">Notes, videos, and presentations.</p>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition-colors duration-200 material-link" data-subject="${subject.name}" data-type="labs">
                            <h3 class="text-lg font-semibold text-white">Lab Work</h3>
                            <p class="text-sm text-gray-400">Manuals, simulations, and reports.</p>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition-colors duration-200 material-link" data-subject="${subject.name}" data-type="tutorials">
                            <h3 class="text-lg font-semibold text-white">Tutorials</h3>
                            <p class="text-sm text-gray-400">Problem sheets and solution guides.</p>
                        </div>
                    </div>
                </div>`;
        };

        const renderSubjects = () => {
            subjectsContainer.innerHTML = '';
            subjects.forEach((subject, index) => {
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = createSubjectCard(subject).trim();
                const cardElement = tempContainer.firstChild;
                subjectsContainer.appendChild(cardElement);
                setTimeout(() => cardElement.classList.add('animate-in'), index * 100);
            });
        };

        const updateWelcomeMessage = (name) => {
            const welcomeOverlay = document.getElementById('welcome-overlay');
            const welcomeTextAnim = document.getElementById('welcome-text-anim');
            const welcomeNameAnim = document.getElementById('welcome-name-anim');
            const userNameDisplay = document.getElementById('user-name-display');

            if (!name) return;

            welcomeNameAnim.textContent = name;
            userNameDisplay.textContent = `Welcome, ${name}!`;
            
            welcomeOverlay.style.display = 'flex'; // Make it visible
            welcomeOverlay.style.opacity = 1;
            
            welcomeTextAnim.style.animation = 'fadeIn 1s forwards';
            welcomeNameAnim.style.animation = 'fadeIn 1s 0.5s forwards';

            setTimeout(() => {
                welcomeOverlay.style.animation = 'fadeOut 1s forwards';
            }, 2500);

            setTimeout(() => {
                welcomeOverlay.style.display = 'none';
                userNameDisplay.style.opacity = '1';
            }, 3500);
        };

        const renderTimetable = (selectedDay) => {
            const now = new Date();
            const currentDayOfWeek = now.toLocaleString('en-US', { weekday: 'long' });
            
            const selectedDayData = timetableData.find(d => d.day === selectedDay);
            const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayButtons = daysOfWeek.map(day => `<button class="day-btn text-xs md:text-sm px-2 py-1 flex-shrink-0 ${day === selectedDay ? 'active' : ''}" data-day="${day}">${day.substring(0, 3)}</button>`).join('');

            let classCardsHTML = '<div class="text-center py-8"><p class="text-lg text-gray-400">No classes are scheduled for today.</p></div>';

            if (selectedDayData && selectedDayData.classes.length > 0) {
                const isCurrentDay = (selectedDay === currentDayOfWeek);
                let upcomingClassIndex = -1;

                if (isCurrentDay) {
                    for (let i = 0; i < selectedDayData.classes.length; i++) {
                        const { start, end } = parseTime(selectedDayData.classes[i].time);
                        if (now >= start && now < end) {
                            upcomingClassIndex = -2; 
                            break;
                        }
                        if (now < start && upcomingClassIndex === -1) {
                            upcomingClassIndex = i;
                        }
                    }
                }

                classCardsHTML = selectedDayData.classes.map((cls, index) => {
                    const { start, end } = parseTime(cls.time);
                    const isCurrentClass = isCurrentDay && (now >= start && now < end);
                    const isUpcomingClass = isCurrentDay && (index === upcomingClassIndex);
                    
                    let glowClass = '';
                    if (isCurrentClass) glowClass = 'current-class-glow';
                    else if (isUpcomingClass) glowClass = 'upcoming-class-glow';

                    return `<div class="bg-gray-900 rounded-lg p-3 text-sm md:text-base flex items-center justify-between border-l-4 border-${cls.color}-400 ${glowClass}"><div><p class="font-medium text-white">${cls.subject} <span class="text-gray-400 font-normal">(${cls.type || ''})</span></p><p class="text-xs text-gray-500">${cls.time}</p></div><span class="text-xl">${cls.icon}</span></div>`;
                }).join('');
            }

            timetableContent.innerHTML = `
                <div class="flex overflow-x-auto whitespace-nowrap space-x-2 pb-2 mb-4 scrollbar-hide" id="day-buttons-container">${dayButtons}</div>
                <div class="p-4 rounded-xl shadow-xl border border-gray-700 bg-gray-800">
                    <h3 class="text-xl font-bold text-center mb-4 text-cyan-300">${selectedDay}</h3>
                    <div class="space-y-3">${classCardsHTML}</div>
                </div>`;
        };
        
        const startTimetableUpdates = () => {
            if (timetableInterval) clearInterval(timetableInterval);
            timetableInterval = setInterval(() => {
                const activeDayBtn = document.querySelector('.day-btn.active');
                if (activeDayBtn) {
                     renderTimetable(activeDayBtn.dataset.day);
                }
            }, 60000);
        };
        
        // --- Core Application Logic ---

        const showPortalContent = () => {
            portalContent.style.display = 'flex';
            updateWelcomeMessage(localStorage.getItem('userName'));
            
            updateClock();
            renderCurrentActivity();
            renderUpcomingEventHighlight();
            renderCountdownTimers();
            currentActivityInterval = setInterval(renderCurrentActivity, 30000);
            countdownInterval = setInterval(renderCountdownTimers, 1000);
            
            // Fetch dynamic content
            fetchSubjects();
            fetchAnnouncements();
        };
        
        // --- Event Listeners ---
        showTimetableBtn.addEventListener('click', () => {
            const currentDayOfWeek = new Date().toLocaleString('en-US', { weekday: 'long' });
            renderTimetable(currentDayOfWeek);
            timetableModal.classList.add('active');
            startTimetableUpdates();
        });

        const openPortalModal = (url) => {
            portalIframe.src = url;
            portalModal.classList.add('active');
            portalLoader.style.display = 'flex';
            portalIframe.onload = () => portalLoader.style.display = 'none';
        };

        eventsContainer.addEventListener('click', () => {
            showPastEvents = false; // Reset view to upcoming only
            togglePastEventsBtn.textContent = 'Show Past Events';
            renderRoadmap();
            roadmapModal.classList.add('active');
        });
        
        togglePastEventsBtn.addEventListener('click', () => {
            showPastEvents = !showPastEvents;
            togglePastEventsBtn.textContent = showPastEvents ? 'Hide Past Events' : 'Show Past Events';
            renderRoadmap();
        });
        
        document.addEventListener('click', (event) => {
            if (event.target.classList.contains('day-btn')) {
                renderTimetable(event.target.dataset.day);
                startTimetableUpdates();
            }
        });
        
        document.addEventListener('click', (event) => {
            const materialLink = event.target.closest('.material-link');
            if (materialLink) {
                const subjectName = materialLink.dataset.subject;
                const type = materialLink.dataset.type;
                const subjectData = subjects.find(s => s.name === subjectName);
                if (subjectData) {
                    openMaterialModal(subjectData, type);
                }
            }
            
            const materialBtn = event.target.closest('.chapter-btn');
            if (materialBtn) {
                const driveLink = materialBtn.dataset.link;
                if (driveLink) {
                    window.open(driveLink, '_blank');
                    materialModal.classList.remove('active');
                }
            }
        });
        
        const openMaterialModal = (subjectData, materialType) => {
            currentSubject = subjectData.name;
            currentMaterialType = materialType;
            materialButtonsContainer.innerHTML = '';
            
            const materials = subjectData[materialType]; // This is now an array
            materialModalTitle.textContent = `Select Material for ${subjectData.name} (${materialType})`;

            if (materials && Array.isArray(materials) && materials.length > 0) {
                 materials.forEach((material) => { // Iterate over the array
                    const materialBtn = document.createElement('button');
                    materialBtn.className = 'chapter-btn';
                    materialBtn.textContent = material.name; // Use the 'name' field
                    materialBtn.dataset.link = material.link; // Use the 'link' field
                    materialButtonsContainer.appendChild(materialBtn);
                });
            } else {
                materialButtonsContainer.innerHTML = `<p class="text-gray-400">No materials available for this section.</p>`;
            }
            
            materialModal.classList.add('active');
        };

        loginForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            loginMessageBox.textContent = '';
            loginMessageBox.classList.remove('error', 'success', 'hidden');
            
            if (username === '') {
                loginMessageBox.classList.add('error', 'bg-red-500', 'text-white', 'p-2', 'rounded');
                loginMessageBox.textContent = 'Please enter your full name.';
            } else if (password === 'A2PORTAL') {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('userName', username);
                loginModal.classList.remove('active');
                showPortalContent();
            } else {
                loginMessageBox.classList.add('error', 'bg-red-500', 'text-white', 'p-2', 'rounded');
                loginMessageBox.textContent = 'Incorrect credentials.';
            }
        });
        
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userName');
            location.reload();
        });

        // --- Modal Close Logic ---
        document.querySelectorAll('.modal').forEach(modal => {
             modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            });
            const closeBtn = modal.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    modal.classList.remove('active');
                });
            }
        });

        discussionModal.addEventListener('click', (e) => {
            if (e.target === discussionModal || e.target.closest('.close-btn')) {
                if (unsubscribeChat) unsubscribeChat();
            }
        });
         plannerModal.addEventListener('click', (e) => {
            if (e.target === plannerModal || e.target.closest('.close-btn')) {
                if (unsubscribePlanner) unsubscribePlanner();
            }
        });
         timetableModal.addEventListener('click', (e) => {
             if(e.target === timetableModal || e.target.closest('.close-btn')) {
                if(timetableInterval) clearInterval(timetableInterval);
             }
         });
         portalModal.addEventListener('click', (e) => {
             if(e.target === portalModal || e.target.closest('.close-btn')) {
                portalIframe.src = "";
             }
         });


        // --- Real-time Discussion Room Logic ---
        const renderGroupChat = (messages) => {
            chatMessagesContainer.innerHTML = '';
            if (messages.length === 0) {
                 chatMessagesContainer.innerHTML = `<div class="text-center text-gray-500 p-4">No messages yet. Be the first to say something!</div>`;
                 return;
            }
            const loggedInUser = localStorage.getItem('userName');
            messages.forEach(msg => {
                const isOwnMessage = msg.name === loggedInUser;
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isOwnMessage ? 'chat-message-own' : 'chat-message-other'}`;
                messageDiv.innerHTML = `<p class="sender-name">${isOwnMessage ? 'You' : msg.name}</p><p>${msg.text}</p>`;
                chatMessagesContainer.appendChild(messageDiv);
            });
            chatMessagesContainer.parentElement.scrollTop = chatMessagesContainer.parentElement.scrollHeight;
        };
        
        const switchToGroupChat = () => {
            if (unsubscribeChat) unsubscribeChat(); 
            
            const q = query(collection(db, "chatMessages"), orderBy("timestamp", "desc"), limit(20));
            try {
                unsubscribeChat = onSnapshot(q, (querySnapshot) => {
                    const messages = [];
                    querySnapshot.forEach((doc) => messages.push(doc.data()));
                    renderGroupChat(messages.reverse());
                });
            } catch (e) {
                console.error("Firestore listener error:", e);
                chatMessagesContainer.innerHTML = `<div class="text-center text-red-400 p-4">Error loading group chat.</div>`;
            }
        };

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            const name = localStorage.getItem('userName');
            if (!text || !name) return;
            chatInput.value = '';
            try {
                await addDoc(collection(db, "chatMessages"), {
                    name: name,
                    text: text,
                    timestamp: new Date()
                });
            } catch (e) {
                console.error("Error sending message:", e);
            }
        });
        
        bellButton.addEventListener('click', () => {
            const isHidden = popUp.style.display === 'none' || popUp.style.display === '';
            popUp.style.animation = isHidden ? 'slideDown 0.3s ease-out' : 'slideUp 0.3s ease-in-out';
            if (isHidden) popUp.style.display = 'flex';
            else setTimeout(() => { popUp.style.display = 'none'; }, 250);
        });

        closeButton.addEventListener('click', () => {
            popUp.style.animation = 'slideUp 0.3s ease-in-out';
            setTimeout(() => { popUp.style.display = 'none'; }, 250);
        });

        window.addEventListener('click', (event) => {
            const clickedInsidePopup = popUp.contains(event.target);
            const clickedBell = bellButton.contains(event.target);
            if (popUp.style.display === 'flex' && !clickedInsidePopup && !clickedBell) {
                popUp.style.animation = 'slideUp 0.3s ease-in-out';
                setTimeout(() => { popUp.style.display = 'none'; }, 250);
            }
        });

        
        // --- GPA Calculator Logic ---
        const addGpaRow = () => {
            const row = document.createElement('div');
            row.className = 'grid grid-cols-[1fr,80px,100px,30px] gap-2 items-center';
            row.innerHTML = `
                <input type="text" placeholder="Subject Name" class="gpa-subject w-full px-2 py-1 rounded bg-gray-700 border-gray-600">
                <input type="number" placeholder="Credits" class="gpa-credits w-full px-2 py-1 rounded bg-gray-700 border-gray-600">
                <select class="gpa-grade w-full px-2 py-1 rounded bg-gray-700 border-gray-600">
                    <option value="10">10</option><option value="9">9</option><option value="8">8</option><option value="7">7</option><option value="6">6</option><option value="5">5</option><option value="0">Fail</option>
                </select>
                <button class="remove-gpa-row text-gray-500 hover:text-red-500">&times;</button>
            `;
            gpaSubjectRows.appendChild(row);
        };
        
        const calculateGpa = () => {
             let totalCredits = 0;
             let totalPoints = 0;
             const rows = gpaSubjectRows.querySelectorAll('.grid');
             rows.forEach(row => {
                 const credits = parseFloat(row.querySelector('.gpa-credits').value) || 0;
                 const grade = parseFloat(row.querySelector('.gpa-grade').value) || 0;
                 if(credits > 0){
                    totalCredits += credits;
                    totalPoints += credits * grade;
                 }
             });

             const sgpa = totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : '0.00';
             
             const currentCgpa = parseFloat(document.getElementById('current-cgpa').value) || 0;
             const creditsDone = parseFloat(document.getElementById('credits-done').value) || 0;
             
             let newCgpa = sgpa;
             if(currentCgpa > 0 && creditsDone > 0) {
                 const oldTotalPoints = currentCgpa * creditsDone;
                 const newTotalCredits = creditsDone + totalCredits;
                 newCgpa = newTotalCredits > 0 ? ((oldTotalPoints + totalPoints) / newTotalCredits).toFixed(2) : '0.00';
             }
             
             gpaResults.innerHTML = `
                <p>SGPA: <span class="font-bold text-2xl text-cyan-400">${sgpa}</span></p>
                <p class="mt-2">New CGPA: <span class="font-bold text-2xl text-teal-400">${newCgpa}</span></p>
             `;
        };

        addSubjectRowBtn.addEventListener('click', addGpaRow);
        gpaSubjectRows.addEventListener('click', (e) => {
            if(e.target.classList.contains('remove-gpa-row')) {
                e.target.parentElement.remove();
                calculateGpa();
            }
        });
        gpaModal.addEventListener('input', calculateGpa);

        // --- Notepad Logic ---
        const saveNote = async () => {
            const username = localStorage.getItem('userName');
            if(!username) return;
            const noteRef = doc(db, 'users', username, 'notepad', 'mainNote');
            await setDoc(noteRef, { content: notepadInput.value });
            notepadStatus.textContent = 'Saved!';
            setTimeout(() => notepadStatus.textContent = '', 2000);
        };
        
        notepadInput.addEventListener('keyup', () => {
            clearTimeout(notepadSaveTimeout);
            notepadStatus.textContent = 'Saving...';
            notepadSaveTimeout = setTimeout(saveNote, 1000);
        });

         // --- Planner Logic ---
        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = taskInput.value.trim();
            const username = localStorage.getItem('userName');
            if (!text || !username) return;
            taskInput.value = '';

            const userTasksRef = collection(db, 'users', username, 'tasks');
            await addDoc(userTasksRef, {
                text: text,
                completed: false,
                createdAt: new Date()
            });
        });
        
        taskList.addEventListener('click', async (e) => {
             const username = localStorage.getItem('userName');
             if(!username) return;
             const taskItem = e.target.closest('.task-item');
             if(!taskItem) return;
             const docId = taskItem.dataset.id;
             const taskDocRef = doc(db, 'users', username, 'tasks', docId);

             if(e.target.classList.contains('task-checkbox')){
                const isCompleted = e.target.checked;
                await setDoc(taskDocRef, { completed: isCompleted }, { merge: true });
             }
             if(e.target.classList.contains('delete-task')){
                 await deleteDoc(taskDocRef);
             }
        });

        // --- Toolkit Buttons Opening Modals ---
        document.getElementById('planner-btn').addEventListener('click', () => {
            const username = localStorage.getItem('userName');
            if(!username) return;
            plannerModal.classList.add('active');
            
            if(unsubscribePlanner) unsubscribePlanner();
            const userTasksRef = collection(db, 'users', username, 'tasks');
            unsubscribePlanner = onSnapshot(userTasksRef, (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks(tasks);
            });
        });

        document.getElementById('gpa-btn').addEventListener('click', () => {
            gpaModal.classList.add('active');
            if(gpaSubjectRows.children.length === 0) {
                 for(let i = 0; i < 5; i++) addGpaRow();
            }
            calculateGpa();
        });

        document.getElementById('notepad-btn').addEventListener('click', async () => {
             const username = localStorage.getItem('userName');
            if(!username) return;
            notepadModal.classList.add('active');
            const noteRef = doc(db, 'users', username, 'notepad', 'mainNote');
            const docSnap = await getDoc(noteRef);
            if (docSnap.exists()) {
                notepadInput.value = docSnap.data().content;
            } else {
                 notepadInput.value = '';
            }
            notepadStatus.textContent = '';
        });
        
        document.getElementById('attendance-btn').addEventListener('click', () => openPortalModal('https://jportal2-0.vercel.app/#/attendance'));
        document.getElementById('mess-btn').addEventListener('click', () => openPortalModal('https://mess-schedule.vercel.app/'));
        document.getElementById('discussion-btn').addEventListener('click', () => {
             discussionModal.classList.add('active');
             switchToGroupChat(); 
        });

        // --- Page Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('isLoggedIn') === 'true') {
                loginModal.classList.remove('active');
                showPortalContent();
                setTimeout(() => {
                    bellButton.click();
                    setTimeout(() => bellButton.click(), 5000);
                }, 3600); // Delay this to not interfere with welcome animation
            } else {
                loginModal.classList.add('active');
            }
        });
    </script>
</body>
</html>
